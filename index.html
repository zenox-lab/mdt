<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-M-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Diário de Trades</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Estilos customizados */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        /* O Tailwind usa 'dark' por padrão, mas vamos garantir */
        html.dark {
            color-scheme: dark;
        }
        /* Para navegadores que não suportam color-scheme */
        .dark body {
            background-color: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
        }
        
        /* Estilos do Calendário */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .calendar-day {
            min-height: 100px;
            position: relative;
            transition: background-color 0.2s;
        }
        .calendar-day:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .day-number {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.75rem;
        }
        .day-result {
            font-size: 0.875rem;
            font-weight: 600;
            padding: 4px;
            border-radius: 4px;
            margin-top: 24px;
            text-align: center;
        }
        .trade-profit {
            background-color: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        .trade-loss {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        .trade-count {
            font-size: 0.65rem;
            color: #6b7280;
        }
        .dark .trade-count {
            color: #9ca3af;
        }

        /* Animação do Modal */
        #tradeModal {
            transition: opacity 0.3s ease-out;
        }

        /* Estilo dos botões de rádio para Buy/Sell */
        .radio-buy-sell input[type="radio"] {
            display: none;
        }
        .radio-buy-sell label {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
            border: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }
        /* Estilo Buy */
        .radio-buy-sell input[value="Buy"] + label {
            border-color: #22c55e; /* green-500 */
            color: #22c55e;
        }
        .radio-buy-sell input[value="Buy"]:checked + label {
            background-color: #22c55e;
            color: white;
        }
        /* Estilo Sell */
        .radio-buy-sell input[value="Sell"] + label {
            border-color: #ef4444; /* red-500 */
            color: #ef4444;
        }
        .radio-buy-sell input[value="Sell"]:checked + label {
            background-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Cabeçalho com Título e Botões de Ação -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400">Meu Diário de Trades</h1>
            
            <div class="flex items-center space-x-4">
                <!-- Botão de Tema -->
                <button id="themeToggle" class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors p-2 rounded-full bg-gray-200 dark:bg-gray-800">
                    <i class="fas fa-sun" id="themeIconSun"></i>
                    <i class="fas fa-moon hidden" id="themeIconMoon"></i>
                </button>
                
                <!-- Botões de Navegação -->
                <nav class="flex space-x-1 bg-gray-200 dark:bg-gray-800 p-1 rounded-lg">
                    <button data-tab="diario" class="tab-btn bg-white dark:bg-gray-700 text-blue-600 dark:text-blue-300 py-2 px-4 rounded-md font-medium text-sm">Diário</button>
                    <button data-tab="patrimonio" class="tab-btn text-gray-600 dark:text-gray-400 py-2 px-4 rounded-md font-medium text-sm">Patrimônio</button>
                    <button data-tab="analise" class="tab-btn text-gray-600 dark:text-gray-400 py-2 px-4 rounded-md font-medium text-sm">Análise</button>
                </nav>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main>

            <!-- ABA 1: Diário (Calendário) -->
            <div id="diario" class="tab-content">
                <!-- Controles do Calendário -->
                <div class="flex justify-between items-center mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                    <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h2 id="currentMonthYear" class="text-xl md:text-2xl font-semibold"></h2>
                    <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <!-- Resumo Mensal -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow text-center">
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Resultado Líquido</h4>
                        <p id="netResult" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow text-center">
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total de Trades</h4>
                        <p id="totalTrades" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow text-center">
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Taxa de Acerto</h4>
                        <p id="winRate" class="text-2xl font-bold">0%</p>
                    </div>
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow text-center">
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Média Lucro/Preju.</h4>
                        <p id="avgProfitLoss" class="text-2xl font-bold">R$ 0,00</p>
                    </div>
                </div>

                <!-- Grid do Calendário -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                    <!-- Cabeçalho dos Dias da Semana -->
                    <div class="calendar-grid border-b border-gray-200 dark:border-gray-700">
                        <div class="p-2 text-center font-semibold text-xs text-gray-500 dark:text-gray-400 uppercase">Dom</div>
                        <div class="p-2 text-center font-semibold text-xs text-gray-500 dark:text-gray-400 uppercase">Seg</div>
                        <div class="p-2 text-center font-semibold text-xs text-gray-500 dark:text-gray-400 uppercase">Ter</div>
                        <div class="p-2 text-center font-semibold text-xs text-gray-500 dark:text-gray-400 uppercase">Qua</div>
                        <div class="p-2 text-center font-semibold text-xs text-gray-500 dark:text-gray-400 uppercase">Qui</div>
                        <div class="p-2 text-center font-semibold text-xs text-gray-500 dark:text-gray-400 uppercase">Sex</div>
                        <div class="p-2 text-center font-semibold text-xs text-gray-500 dark:text-gray-400 uppercase">Sáb</div>
                    </div>
                    <!-- Dias do Calendário -->
                    <div id="calendarGrid" class="calendar-grid">
                        <!-- Dias serão preenchidos pelo JavaScript -->
                    </div>
                </div>
            </div>

            <!-- ABA 2: Patrimônio (Gráfico) -->
            <div id="patrimonio" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 md:p-6">
                    <h2 class="text-xl font-semibold mb-4">Evolução do Patrimônio</h2>
                    <div class="mb-4 flex items-center space-x-2">
                        <label for="initialEquity" class="text-sm font-medium text-gray-700 dark:text-gray-300">Patrimônio Inicial (R$):</label>
                        <input type="number" id="initialEquity" value="0" class="w-32 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="updateEquityChart" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-md font-medium text-white transition-colors">Atualizar</button>
                    </div>
                    <canvas id="equityChart" height="120"></canvas>
                </div>
            </div>

            <!-- ABA 3: Análise -->
            <div id="analise" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 md:p-6">
                    <h2 class="text-xl font-semibold mb-4">Análise de Performance</h2>
                    
                    <!-- Resumos de Alto Nível -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Análise por Ativo -->
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Resultado Geral por Ativo</h3>
                            <div id="analysisByAsset" class="space-y-2">
                                <!-- Conteúdo gerado por JS -->
                            </div>
                        </div>
                        <!-- Análise por Tipo (Buy/Sell) -->
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Resultado Geral por Tipo</h3>
                            <div id="analysisByType" class="space-y-2">
                                <!-- Conteúdo gerado por JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Análise Detalhada -->
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-4 border-t border-gray-200 dark:border-gray-700 pt-6">Desempenho Detalhado por Ativo</h3>
                        <div id="detailedAnalysis" class="space-y-4">
                            <!-- Conteúdo gerado por JS -->
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal para Adicionar/Editar Trade -->
    <div id="tradeModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-75 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <button id="closeModal" class="absolute top-3 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-2xl">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Operações do Dia</h3>
            
            <!-- Lista de Trades do Dia -->
            <div id="dailyTradesList" class="mb-4 max-h-32 overflow-y-auto border-y border-gray-200 dark:border-gray-700 divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Trades serão injetados aqui pelo JS -->
            </div>

            <h4 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200" id="formTitle">Adicionar Nova Operação</h4>
            <form id="tradeForm">
                <input type="hidden" id="tradeDate">
                
                <!-- Valor -->
                <div class="mb-4">
                    <label for="tradeAmount" class="block text-sm font-medium mb-1">Valor (R$)</label>
                    <input type="number" id="tradeAmount" step="0.01" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 150.00 (lucro) ou -50.00 (prejuízo)" required>
                </div>

                <!-- Tipo (Buy/Sell) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Tipo</label>
                    <div class="flex space-x-4 radio-buy-sell">
                        <div class="flex items-center">
                            <input type="radio" id="typeBuy" name="tradeType" value="Buy" checked>
                            <label for="typeBuy">Buy</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="typeSell" name="tradeType" value="Sell">
                            <label for="typeSell">Sell</label>
                        </div>
                    </div>
                </div>
                
                <!-- Ativo e Contratos -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="tradeAsset" class="block text-sm font-medium mb-1">Ativo</label>
                        <select id="tradeAsset" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione...</option>
                            <option value="XAUUSD">XAUUSD</option>
                            <option value="S&P500">S&P500</option>
                            <option value="Nasdaq">Nasdaq</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label for="tradeContracts" class="block text-sm font-medium mb-1">Contratos</label>
                        <input type="number" id="tradeContracts" step="1" min="1" value="1" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Notas -->
                <div class="mb-6">
                    <label for="tradeNotes" class="block text-sm font-medium mb-1">Notas (Opcional)</label>
                    <textarea id="tradeNotes" rows="2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Rompimento de topo..."></textarea>
                </div>

                <!-- Botões de Ação -->
                <div class="flex justify-end space-x-4">
                    <button type="button" id="deleteTrade" class="py-2 px-5 bg-red-600 hover:bg-red-700 rounded-md font-medium text-white transition-colors hidden">Excluir</button>
                    <button type="submit" id="saveTradeBtn" class="py-2 px-5 bg-blue-600 hover:bg-blue-700 rounded-md font-medium text-white transition-colors">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- ================== -->
    <!-- JAVASCRIPT E FIREBASE -->
    <!-- ================== -->
    
    <script type="module">
        // --- IMPORTS DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- CONFIGURAÇÃO DO FIREBASE (PARA GITHUB) ---
        
        // ESTA É A SUA CONFIGURAÇÃO REAL DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDYXehc5ijr11GD029ph7-6a0oVy9ddcKY",
            authDomain: "meu-diario-de-trades.firebaseapp.com",
            projectId: "meu-diario-de-trades",
            storageBucket: "meu-diario-de-trades.firebasestorage.app",
            messagingSenderId: "744192474673",
            appId: "1:744192474673:web:c5adf1d9526b81deed1f10",
            measurementId: "G-LM9V31W7BE"
        };
        
        // O 'appId' é usado para criar o caminho do banco de dados
        const appId = 'meu-diario-de-trades';

        // --- INICIALIZAÇÃO DO FIREBASE ---
        let app, db, auth, userId, operationsCollection;
        let currentTrades = []; // Armazena os trades buscados
        let equityChartInstance = null; // Instância do gráfico
        let currentEditingTradeId = null; // ID do trade sendo editado

        // --- Variáveis de Estado do Calendário ---
        let currentDate = new Date();
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        // --- Seletores de Elementos DOM ---
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const calendarGridEl = document.getElementById('calendarGrid');
        const modal = document.getElementById('tradeModal');
        const closeModalBtn = document.getElementById('closeModal');
        const tradeForm = document.getElementById('tradeForm');
        const tradeAmountEl = document.getElementById('tradeAmount');
        const tradeContractsEl = document.getElementById('tradeContracts'); // Novo campo
        const tradeAssetEl = document.getElementById('tradeAsset');
        const tradeNotesEl = document.getElementById('tradeNotes');
        const deleteTradeBtn = document.getElementById('deleteTrade');
        const saveTradeBtn = document.getElementById('saveTradeBtn'); // Botão de salvar/atualizar
        const dailyTradesListEl = document.getElementById('dailyTradesList'); // Lista no modal
        const formTitleEl = document.getElementById('formTitle'); // Título do formulário
        
        // Resumo
        const netResultEl = document.getElementById('netResult');
        const totalTradesEl = document.getElementById('totalTrades');
        const winRateEl = document.getElementById('winRate');
        const avgProfitLossEl = document.getElementById('avgProfitLoss');

        // Gráfico
        const equityChartEl = document.getElementById('equityChart').getContext('2d');
        const initialEquityEl = document.getElementById('initialEquity');
        const updateEquityChartBtn = document.getElementById('updateEquityChart');
        
        // Análise
        const analysisByAssetEl = document.getElementById('analysisByAsset');
        const analysisByTypeEl = document.getElementById('analysisByType');
        const detailedAnalysisEl = document.getElementById('detailedAnalysis'); // NOVO

        // Navegação
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        // Tema
        const themeToggle = document.getElementById('themeToggle');
        const themeIconSun = document.getElementById('themeIconSun');
        const themeIconMoon = document.getElementById('themeIconMoon');

        // Data de edição
        let currentEditingDate = null;
        
        function openModal(date) {
            if (!date) return;
            currentEditingDate = date;
            
            resetForm(); // Reseta o formulário e o estado de edição

            // --- Popula a Lista de Trades ---
            dailyTradesListEl.innerHTML = '';
            const tradesOfTheDay = currentTrades.filter(t => t.date === date).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));

            if (tradesOfTheDay.length > 0) {
                tradesOfTheDay.forEach(trade => {
                    const amount = parseFloat(trade.amount);
                    const typeLabel = trade.type === 'Buy' ? 'B' : 'S';
                    const assetLabel = trade.asset || 'N/A';
                    const contracts = trade.contracts || 1;
                    const amountColor = amount >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';

                    dailyTradesListEl.innerHTML += `
                        <div class="p-2 flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50" data-trade-id="${trade.id}">
                            <div>
                                <span class="font-bold ${amountColor}">R$ ${amount.toFixed(2)}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(${contracts}c, ${assetLabel}/${typeLabel})</span>
                            </div>
                            <i class="fas fa-pencil-alt text-xs text-gray-400"></i>
                        </div>
                    `;
                });
                // Adiciona listeners de clique aos itens da lista
                dailyTradesListEl.querySelectorAll('[data-trade-id]').forEach(item => {
                    item.addEventListener('click', () => loadTradeForEdit(item.dataset.tradeId));
                });
            } else {
                dailyTradesListEl.innerHTML = '<p class="p-3 text-sm text-gray-400 dark:text-gray-500 text-center">Nenhuma operação neste dia.</p>';
            }
            
            // Mostra o modal
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            
            // Foco no campo de valor
            tradeAmountEl.focus();
        }
        
        function resetForm() {
            tradeForm.reset();
            tradeAmountEl.value = '';
            tradeContractsEl.value = '1';
            tradeAssetEl.value = '';
            tradeNotesEl.value = '';
            document.querySelector('input[name="tradeType"][value="Buy"]').checked = true; // Padrão Buy
            
            currentEditingTradeId = null; // Limpa o ID de edição
            
            deleteTradeBtn.classList.add('hidden'); // Esconde botão de deletar
            saveTradeBtn.textContent = 'Salvar'; // Reseta texto do botão
            formTitleEl.textContent = 'Adicionar Nova Operação'; // Reseta título

            // Limpa destaque da lista
            dailyTradesListEl.querySelectorAll('.bg-blue-100').forEach(el => {
                 el.classList.remove('bg-blue-100', 'dark:bg-blue-900/50');
            });
        }
        
        function loadTradeForEdit(tradeId) {
            const trade = currentTrades.find(t => t.id === tradeId);
            if (!trade) return;

            // 1. Preenche o formulário
            tradeAmountEl.value = trade.amount;
            tradeContractsEl.value = trade.contracts || 1;
            tradeAssetEl.value = trade.asset || '';
            tradeNotesEl.value = trade.notes || '';
            document.querySelector(`input[name="tradeType"][value="${trade.type || 'Buy'}"]`).checked = true;

            // 2. Define o estado de edição
            currentEditingTradeId = tradeId;
            
            // 3. Atualiza a UI do modal
            saveTradeBtn.textContent = 'Atualizar';
            formTitleEl.textContent = 'Editar Operação';
            deleteTradeBtn.classList.remove('hidden');
            
            // 4. Destaca o item na lista
            dailyTradesListEl.querySelectorAll('[data-trade-id]').forEach(item => {
                item.classList.remove('bg-blue-100', 'dark:bg-blue-900/50');
                if (item.dataset.tradeId === tradeId) {
                    item.classList.add('bg-blue-100', 'dark:bg-blue-900/50');
                }
            });
            
            tradeAmountEl.focus();
        }
        
        function closeModal() {
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            currentEditingDate = null;
            resetForm(); // Garante que o formulário seja resetado ao fechar
        }

        closeModalBtn.onclick = closeModal;
        
        // Fechar modal ao clicar fora
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        function renderCalendar() {
            calendarGridEl.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Filtra trades para o mês atual
            const monthTrades = currentTrades.filter(t => {
                const [tYear, tMonth] = t.date.split('-').map(Number);
                return tYear === year && (tMonth - 1) === month;
            });
            
            // Agrupa trades por dia
            const tradesByDay = {};
            monthTrades.forEach(trade => {
                const day = parseInt(trade.date.split('-')[2]);
                if (!tradesByDay[day]) {
                    tradesByDay[day] = [];
                }
                tradesByDay[day].push(parseFloat(trade.amount));
            });

            // Preenche dias em branco
            for (let i = 0; i < firstDay; i++) {
                calendarGridEl.innerHTML += `<div class="calendar-day border-r border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"></div>`;
            }
            
            // Preenche os dias do mês
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayTrades = tradesByDay[day] || [];
                let dayResult = dayTrades.reduce((acc, val) => acc + val, 0);
                
                let resultClass = '';
                let resultHTML = '';
                
                if (dayTrades.length > 0) {
                    resultClass = dayResult >= 0 ? 'trade-profit' : 'trade-loss';
                    resultHTML = `
                        <div class="day-result ${resultClass}">
                            R$ ${dayResult.toFixed(2)}
                        </div>
                        <div class="trade-count text-center">
                            ${dayTrades.length} trade${dayTrades.length > 1 ? 's' : ''}
                        </div>
                    `;
                }

                calendarGridEl.innerHTML += `
                    <div class="calendar-day border-r border-b border-gray-200 dark:border-gray-700 p-1 cursor-pointer" data-date="${dateString}">
                        <span class="day-number text-gray-500 dark:text-gray-400">${day}</span>
                        ${resultHTML}
                    </div>
                `;
            }
            
            // Adiciona listeners de clique aos dias
            calendarGridEl.querySelectorAll('.calendar-day[data-date]').forEach(dayEl => {
                dayEl.addEventListener('click', () => openModal(dayEl.dataset.date));
            });

            // Atualiza o resumo mensal
            updateSummary(monthTrades);
        }

        function updateSummary(monthTrades) {
            const totalResult = monthTrades.reduce((acc, t) => acc + parseFloat(t.amount), 0);
            const winningTrades = monthTrades.filter(t => parseFloat(t.amount) > 0).length;
            const losingTrades = monthTrades.filter(t => parseFloat(t.amount) < 0).length;
            const total = monthTrades.length;
            
            netResultEl.textContent = `R$ ${totalResult.toFixed(2)}`;
            netResultEl.className = totalResult >= 0 ? 'text-2xl font-bold text-green-500' : 'text-2xl font-bold text-red-500';
            
            totalTradesEl.textContent = total;
            
            const winRate = total > 0 ? (winningTrades / total) * 100 : 0;
            winRateEl.textContent = `${winRate.toFixed(0)}%`;
            
            const avgProfit = winningTrades > 0 ? monthTrades.filter(t => parseFloat(t.amount) > 0).reduce((acc, t) => acc + parseFloat(t.amount), 0) / winningTrades : 0;
            const avgLoss = losingTrades > 0 ? monthTrades.filter(t => parseFloat(t.amount) < 0).reduce((acc, t) => acc + parseFloat(t.amount), 0) / losingTrades : 0;
            
            // Evita divisão por zero se avgLoss for 0
            const avgPL = (avgLoss === 0) ? (avgProfit > 0 ? 'Pos' : 'R$ 0,00') : `R$ ${(avgProfit / Math.abs(avgLoss)).toFixed(2)}`;
            // Simplificado para Média de Resultado por Trade
            const avgPerTrade = total > 0 ? totalResult / total : 0;
            avgProfitLossEl.textContent = `R$ ${avgPerTrade.toFixed(2)}`;
        }

        // Navegação do Calendário
        document.getElementById('prevMonth').onclick = () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        };
        document.getElementById('nextMonth').onclick = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        };
        
        // --- Lógica do Formulário (Salvar/Editar) ---
        tradeForm.onsubmit = async (e) => {
            e.preventDefault();
            
            const amount = parseFloat(tradeAmountEl.value);
            const contracts = parseInt(tradeContractsEl.value) || 1;
            const tradeTypeInput = document.querySelector('input[name="tradeType"]:checked');
            
            if (isNaN(amount)) {
                console.warn("Valor inválido."); // Substituído alert
                return;
            }
            if (!tradeTypeInput) {
                console.warn("Selecione um tipo (Buy/Sell)."); // Substituído alert
                return;
            }
            if (!tradeAssetEl.value) {
                console.warn("Selecione um ativo."); // Substituído alert
                return;
            }
            
            const tradeType = tradeTypeInput.value;
            
            const tradeData = {
                userId: userId, // Continua guardando quem criou, por segurança
                date: currentEditingDate,
                amount: amount,
                contracts: contracts, // Novo campo
                asset: tradeAssetEl.value, // Valor do select
                type: tradeType, // Novo campo (Buy/Sell)
                notes: tradeNotesEl.value || '',
                // createdAt é definido abaixo
            };

            try {
                if (currentEditingTradeId) {
                    // --- LÓGICA DE ATUALIZAÇÃO ---
                    tradeData.updatedAt = new Date().toISOString(); // Adiciona data de atualização
                    const docRef = doc(operationsCollection, currentEditingTradeId);
                    await setDoc(docRef, tradeData, { merge: true }); // Usamos setDoc com merge para garantir
                    console.log("Trade atualizado com ID: ", currentEditingTradeId);
                } else {
                    // --- LÓGICA DE ADIÇÃO (EXISTENTE) ---
                    tradeData.createdAt = new Date().toISOString();
                    const docRef = await addDoc(operationsCollection, tradeData);
                    console.log("Trade salvo com ID: ", docRef.id);
                }
                
                // Se a adição/edição for bem-sucedida, resetamos o formulário
                // para permitir adicionar outro trade no mesmo dia sem fechar.
                resetForm(); // Apenas resetamos o formulário
                openModal(currentEditingDate); // Recarregamos a lista de trades do dia
                
                // O onSnapshot vai atualizar o calendário e gráficos
                
            } catch (error) {
                console.error("Erro ao salvar trade: ", error);
                console.warn("Erro ao salvar. Tente novamente."); // Substituído alert
            }
        };
        
        // Lógica de Exclusão
        deleteTradeBtn.onclick = async () => {
            if (!currentEditingTradeId) return;
            
            // Idealmente, usaríamos um modal de confirmação, 
            // mas por simplicidade vamos deletar direto.
            console.log("Deletando trade:", currentEditingTradeId);
            try {
                const docRef = doc(operationsCollection, currentEditingTradeId);
                await deleteDoc(docRef);
                console.log("Trade deletado.");
                
                // Após deletar, resetamos o formulário e recarregamos a lista
                resetForm();
                openModal(currentEditingDate); 
                
                // O onSnapshot cuidará de atualizar o resto da UI
                
            } catch (error) {
                console.error("Erro ao deletar trade: ", error);
                console.warn("Erro ao deletar. Tente novamente.");
            }
        };

        // --- Lógica do Gráfico de Patrimônio ---
        function updateEquityChart() {
            const initialEquity = parseFloat(initialEquityEl.value) || 0;
            
            // Ordena todos os trades por data
            const sortedTrades = [...currentTrades].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const labels = ['Início'];
            const data = [initialEquity];
            
            let currentEquity = initialEquity;
            
            // Agrupa resultados por dia
            const dailyResults = {};
            sortedTrades.forEach(trade => {
                const date = trade.date;
                if (!dailyResults[date]) {
                    dailyResults[date] = 0;
                }
                dailyResults[date] += parseFloat(trade.amount);
            });
            
            // Cria os pontos do gráfico
            Object.keys(dailyResults).sort().forEach(date => {
                currentEquity += dailyResults[date];
                labels.push(date); // Usar a data como label
                data.push(currentEquity.toFixed(2));
            });
            
            // Detecta o modo escuro
            const isDarkMode = document.documentElement.classList.contains('dark');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDarkMode ? '#f3f4f6' : '#111827';

            if (equityChartInstance) {
                equityChartInstance.destroy();
            }
            
            equityChartInstance = new Chart(equityChartEl, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Patrimônio',
                        data: data,
                        borderColor: '#3b82f6', // blue-500
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: labelColor,
                                // Formata como R$
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: labelColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: labelColor
                            }
                        }
                    }
                }
            });
        }
        
        updateEquityChartBtn.onclick = updateEquityChart;

        // --- Lógica da Aba de Análise ---
        function updateAnalysis() {
            analysisByAssetEl.innerHTML = '';
            analysisByTypeEl.innerHTML = '';
            detailedAnalysisEl.innerHTML = ''; // Limpa a nova secção
            
            const analysis = {
                byAsset: {},
                byType: {}
            };
            
            // 1. Processa todos os trades
            currentTrades.forEach(trade => {
                const amount = parseFloat(trade.amount);
                const asset = trade.asset || 'N/A';
                const type = trade.type || 'N/A'; // 'Buy' or 'Sell'
                const contracts = parseInt(trade.contracts) || 1;

                // --- Inicializa estruturas ---
                if (!analysis.byAsset[asset]) {
                    analysis.byAsset[asset] = {
                        total: 0,
                        count: 0,
                        buy: { total: 0, wins: 0, losses: 0, count: 0, contracts: 0 },
                        sell: { total: 0, wins: 0, losses: 0, count: 0, contracts: 0 }
                    };
                }
                if (!analysis.byType[type]) {
                    analysis.byType[type] = { total: 0, wins: 0, losses: 0, count: 0, contracts: 0 };
                }

                // --- Agrega por Tipo (Geral) ---
                analysis.byType[type].total += amount;
                analysis.byType[type].count++;
                analysis.byType[type].contracts += contracts;
                if (amount > 0) analysis.byType[type].wins++;
                if (amount < 0) analysis.byType[type].losses++;

                // --- Agrega por Ativo (Geral) ---
                analysis.byAsset[asset].total += amount;
                analysis.byAsset[asset].count++;

                // --- Agrega por Ativo (Detalhado Buy/Sell) ---
                const detailType = (type === 'Buy') ? 'buy' : (type === 'Sell' ? 'sell' : null);
                
                if (detailType) {
                    analysis.byAsset[asset][detailType].total += amount;
                    analysis.byAsset[asset][detailType].count++;
                    analysis.byAsset[asset][detailType].contracts += contracts;
                    if (amount > 0) analysis.byAsset[asset][detailType].wins++;
                    if (amount < 0) analysis.byAsset[asset][detailType].losses++;
                }
            });

            // --- 2. Renderização ---

            // Helper: Resumo Geral por Ativo
            const renderSummaryRow = (label, data) => {
                const totalColor = data.total >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                const totalWins = data.buy.wins + data.sell.wins;
                const totalLosses = data.buy.losses + data.sell.losses;
                const totalContracts = data.buy.contracts + data.sell.contracts;
                const summaryWinRate = data.count > 0 ? ((totalWins / data.count) * 100).toFixed(0) : 0;

                return `
                    <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg flex justify-between items-center">
                        <span class="font-semibold text-base">${label}</span>
                        <div class="text-right">
                            <span class="font-bold text-lg ${totalColor}">R$ ${data.total.toFixed(2)}</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${totalWins} W / ${totalLosses} L (${summaryWinRate}%) | ${totalContracts} Contratos</p>
                        </div>
                    </div>
                `;
            };

            // Helper: Resumo Geral por Tipo
            const renderTypeRow = (label, data) => {
                const totalColor = data.total >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                const winRate = data.count > 0 ? (data.wins / data.count * 100).toFixed(0) : 0;
                return `
                    <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg flex justify-between items-center">
                        <span class="font-semibold text-base">${label}</span>
                        <div class="text-right">
                            <span class="font-bold text-lg ${totalColor}">R$ ${data.total.toFixed(2)}</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${data.wins} W / ${data.losses} L (${winRate}%) | ${data.contracts} Contratos</p>
                        </div>
                    </div>
                `;
            };
            
            // Helper: Detalhe (Buy/Sell)
            const renderDetailRow = (label, data) => {
                if (data.count === 0) {
                    return `
                        <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                            <span class="font-semibold">${label}</span>
                            <span class="text-xs text-gray-400">Nenhum trade</span>
                        </div>
                    `;
                }
                const totalColor = data.total >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                const winRate = (data.wins / data.count * 100).toFixed(0);
                return `
                    <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                        <div>
                            <span class="font-semibold">${label}</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${data.wins} W / ${data.losses} L (${winRate}%) | ${data.contracts} Contratos</p>
                        </div>
                        <span class="font-bold ${totalColor}">R$ ${data.total.toFixed(2)}</span>
                    </div>
                `;
            };

            // Renderiza Resumo por Ativo
            if (Object.keys(analysis.byAsset).length === 0) {
                 analysisByAssetEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Sem dados.</p>';
            } else {
                Object.entries(analysis.byAsset).sort((a,b) => b[1].total - a[1].total).forEach(([asset, data]) => {
                    analysisByAssetEl.innerHTML += renderSummaryRow(asset, data);
                });
            }

            // Renderiza Resumo por Tipo
            if (Object.keys(analysis.byType).length === 0) {
                 analysisByTypeEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Sem dados.</p>';
            } else {
                Object.entries(analysis.byType).sort((a,b) => b[1].total - a[1].total).forEach(([type, data]) => {
                    analysisByTypeEl.innerHTML += renderTypeRow(type, data);
                });
            }
            
            // Renderiza Análise Detalhada
            if (Object.keys(analysis.byAsset).length > 0) {
                Object.entries(analysis.byAsset).sort((a,b) => b[1].total - a[1].total).forEach(([asset, data]) => {
                    detailedAnalysisEl.innerHTML += `
                        <div class="p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm mb-4">
                            <h4 class="text-lg font-semibold mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">${asset}</h4>
                            <div class="space-y-2">
                                ${renderDetailRow('Buy', data.buy)}
                                ${renderDetailRow('Sell', data.sell)}
                            </div>
                        </div>
                    `;
                });
            } else {
                detailedAnalysisEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Sem dados para análise detalhada.</p>';
            }
        }
        
        
        // --- Lógica de Navegação por Abas ---
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                
                // Botões
                tabBtns.forEach(b => {
                    b.classList.remove('bg-white', 'dark:bg-gray-700', 'text-blue-600', 'dark:text-blue-300');
                    b.classList.add('text-gray-600', 'dark:text-gray-400');
                });
                btn.classList.add('bg-white', 'dark:bg-gray-700', 'text-blue-600', 'dark:text-blue-300');
                btn.classList.remove('text-gray-600', 'dark:text-gray-400');
                
                // Conteúdo
                tabContents.forEach(content => {
                    if (content.id === tabId) {
                        content.classList.remove('hidden');
                        // Atualiza os dados da aba ativa
                        if (tabId === 'patrimonio') updateEquityChart();
                        if (tabId === 'analise') updateAnalysis();
                    } else {
                        content.classList.add('hidden');
                    }
                });
            });
        });

        // --- Lógica do Tema (Claro/Escuro) ---
        function setMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                themeIconSun.classList.add('hidden');
                themeIconMoon.classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconSun.classList.remove('hidden');
                themeIconMoon.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            }
            // Atualiza o gráfico se ele já existir
            if (equityChartInstance) {
                updateEquityChart();
            }
        }

        themeToggle.addEventListener('click', () => {
            setMode(!document.documentElement.classList.contains('dark'));
        });

        // Carrega o tema salvo
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            setMode(true);
        } else {
            setMode(false);
        }

        // --- INICIALIZAÇÃO DO APP (Firebase) ---
        function initializeAppFlow() {
            try {
                console.log("Iniciando Firebase...");
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                getAnalytics(app); // Inicializa o Analytics
                
                // Define o log level para debug (ótimo para desenvolvimento)
                setLogLevel('debug');
                
                console.log("Firebase inicializado. Aguardando autenticação...");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Usuário autenticado:", user.uid);
                        userId = user.uid; // Ainda guardamos o userId para o caso de querer saber *quem* criou
                        
                        // *** MUDANÇA IMPORTANTE (OPÇÃO A) ***
                        // Define o caminho da coleção (PÚBLICO)
                        const collectionPath = `artifacts/${appId}/public/data/operations`;
                        operationsCollection = collection(db, collectionPath);
                        
                        // Inicia o listener de dados
                        startDataListener();
                        
                    } else {
                        console.log("Nenhum usuário logado. Tentando login anônimo...");
                        try {
                            const userCredential = await signInAnonymously(auth);
                            console.log("Login anônimo bem-sucedido:", userCredential.user.uid);
                            // O listener onAuthStateChanged vai ser chamado novamente com o novo usuário
                        } catch (error) {
                            console.error("Erro no login anônimo:", error);
                        }
                    }
                });

            } catch (error) {
                console.error("Erro fatal ao inicializar o Firebase:", error);
            }
        }

        function startDataListener() {
            if (!operationsCollection) return;
            
            console.log("Iniciando listener de dados em:", operationsCollection.path);

            // *** MUDANÇA IMPORTANTE (OPÇÃO A) ***
            // Cria uma query para buscar TODOS os dados da coleção pública
            // Removemos o 'where("userId", "==", userId)'
            const q = query(operationsCollection);

            // onSnapshot é o listener em tempo real
            onSnapshot(q, (snapshot) => {
                console.log("Dados recebidos do Firestore:", snapshot.size);
                currentTrades = []; // Limpa os dados locais
                snapshot.forEach((doc) => {
                    currentTrades.push({ id: doc.id, ...doc.data() });
                });
                
                // Atualiza a UI
                renderCalendar();
                
                // Atualiza abas abertas (se estiverem visíveis)
                if (!document.getElementById('patrimonio').classList.contains('hidden')) {
                    updateEquityChart();
                }
                if (!document.getElementById('analise').classList.contains('hidden')) {
                    updateAnalysis();
                }
                
            }, (error) => {
                console.error("Erro ao buscar dados (onSnapshot):", error);
                // Aqui poderíamos mostrar uma mensagem de erro na UI
            });
        }
        
        // --- Ponto de Entrada ---
        initializeAppFlow();
        
    </script>
</body>
</html>

