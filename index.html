<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Diário de Trades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* 1 - Quadrados menores */
        .day-box { @apply aspect-square flex flex-col items-center justify-center text-xs relative; }
        .value-box {
            @apply absolute inset-0 flex items-center justify-center font-black text-lg rounded-lg;
            background: rgba(34,197,94,0.08); /* verde bem claro */
            color: #166534;
        }
        .value-box.loss {
            background: rgba(239,68,68,0.08); /* vermelho bem claro */
            color: #991b1b;
        }
        /* 2 - Bolinha de trade */
        .has-trade::after {
            content: '';
            @apply absolute top-1 right-1 w-2 h-2 bg-gradient-to-br from-emerald-400 to-teal-600 rounded-full shadow-md;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">

        <!-- HEADER -->
        <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
            <div class="flex items-center gap-3">
                <i class="fas fa-chart-line text-4xl text-blue-600 dark:text-blue-400"></i>
                <h1 class="text-3xl md:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500">
                    Diário de Trades
                </h1>
            </div>
            <div class="flex items-center gap-3">
                <button id="themeToggle" class="p-3 rounded-xl bg-white/80 dark:bg-gray-800/80 backdrop-blur shadow-lg hover:shadow-xl transition-all">
                    <i class="fas fa-sun text-yellow-500" id="sun"></i>
                    <i class="fas fa-moon hidden text-indigo-400" id="moon"></i>
                </button>
                <nav class="flex bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-xl shadow-lg">
                    <button data-tab="diario"   class="tab-btn active px-5 py-3 font-semibold">Diário</button>
                    <button data-tab="patrimonio" class="tab-btn px-5 py-3 font-semibold">Patrimônio</button>
                    <button data-tab="analise"  class="tab-btn px-5 py-3 font-semibold">Análise</button>
                </nav>
            </div>
        </header>

        <!-- DIÁRIO -->
        <section id="diario" class="tab-content space-y-6">
            <div class="flex justify-between items-center p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl">
                <button id="prevMonth" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-chevron-left"></i></button>
                <h2 id="currentMonthYear" class="text-2xl font-bold"></h2>
                <button id="nextMonth" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- RESUMO MENSAL -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-5 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg text-white">
                    <i class="fas fa-wallet text-2xl mb-2"></i>
                    <p class="text-sm opacity-90">Líquido</p>
                    <p id="netResult" class="text-3xl font-black">R$ 0,00</p>
                </div>
                <div class="p-5 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl shadow-lg text-white">
                    <i class="fas fa-exchange-alt text-2xl mb-2"></i>
                    <p class="text-sm opacity-90">Trades</p>
                    <p id="totalTrades" class="text-3xl font-black">0</p>
                </div>
                <div class="p-5 bg-gradient-to-br from-pink-500 to-rose-600 rounded-2xl shadow-lg text-white">
                    <i class="fas fa-trophy text-2xl mb-2"></i>
                    <p class="text-sm opacity-90">Win Rate</p>
                    <p id="winRate" class="text-3xl font-black">0%</p>
                </div>
                <div class="p-5 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl shadow-lg text-white">
                    <i class="fas fa-calculator text-2xl mb-2"></i>
                    <p class="text-sm opacity-90">Média</p>
                    <p id="avgProfitLoss" class="text-3xl font-black">R$ 0,00</p>
                </div>
            </div>

            <!-- CALENDÁRIO -->
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl overflow-hidden">
                <div class="grid grid-cols-7 text-center font-bold text-sm uppercase tracking-wider bg-gradient-to-r from-blue-600 to-cyan-500 text-white py-4">
                    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7"></div>
            </div>

            <!-- NOVO: SALDO DIA / SEMANA / MÊS -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                <div class="p-5 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl text-center">
                    <p class="text-sm opacity-70">Hoje</p>
                    <p id="todayBalance" class="text-3xl font-black text-green-600">R$ 0,00</p>
                </div>
                <div class="p-5 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl text-center">
                    <p class="text-sm opacity-70">Semana</p>
                    <p id="weekBalance" class="text-3xl font-black text-blue-600">R$ 0,00</p>
                </div>
                <div class="p-5 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl text-center">
                    <p class="text-sm opacity-70">Mês</p>
                    <p id="monthBalance" class="text-3xl font-black text-purple-600">R$ 0,00</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-5 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg text-white text-center">
                    <p class="text-sm opacity-90">Maior Gain Semana</p>
                    <p id="biggestGain" class="text-3xl font-black">R$ 0,00</p>
                </div>
                <div class="p-5 bg-gradient-to-br from-rose-500 to-red-600 rounded-2xl shadow-lg text-white text-center">
                    <p class="text-sm opacity-90">Maior Loss Semana</p>
                    <p id="biggestLoss" class="text-3xl font-black">R$ 0,00</p>
                </div>
            </div>
        </section>

        <!-- PATRIMÔNIO -->
        <section id="patrimonio" class="tab-content hidden">
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="fas fa-chart-line text-green-500"></i> Evolução do Patrimônio</h2>
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="number" id="initialEquity" placeholder="Patrimônio inicial" class="px-4 py-3 rounded-xl border bg-white dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50">
                    <button id="updateEquityChart" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold rounded-xl hover:shadow-lg">Atualizar</button>
                </div>
                <canvas id="equityChart" class="max-h-96"></canvas>
            </div>
        </section>

        <!-- ANÁLISE -->
        <section id="analise" class="tab-content hidden space-y-8">
            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-coins text-yellow-500"></i> Por Ativo</h3>
                    <div id="analysisByAsset" class="space-y-3"></div>
                    <p class="text-xs mt-4 opacity-70">Mostra: lucro total, wins/losses, win rate e contratos de cada ativo.</p>
                </div>
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-arrows-alt-h text-purple-500"></i> Por Tipo (Buy ou Sell)</h3>
                    <div id="analysisByType" class="space-y-3"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- MODAL -->
    <div id="tradeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl w-full max-w-lg p-8">
            <button id="closeModal" class="absolute top-4 right-6 text-3xl text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">&times;</button>
            <h3 class="text-2xl font-bold mb-6">Operações do Dia</h3>
            <div id="dailyTradesList" class="max-h-40 overflow-y-auto mb-6 border-y py-2"></div>
            <h4 id="formTitle" class="text-xl font-bold mb-4">Adicionar Operação</h4>
            <form id="tradeForm" class="space-y-5">
                <input type="hidden" id="tradeDate">
                <input type="number" step="0.01" id="tradeAmount" required placeholder="150.00" class="w-full px-4 py-3 rounded-xl border bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50">
                <div class="grid grid-cols-2 gap-4">
                    <select id="tradeAsset" required class="w-full px-4 py-3 rounded-xl border bg-gray-50 dark:bg-gray-700">
                        <option value="">Ativo</option>
                        <option>XAUUSD</option>
                        <option>S&P500</option>
                        <option>Nasdaq</option>
                        <option>Outro</option>
                    </select>
                    <input type="number" id="tradeContracts" min="1" value="1" class="w-full px-4 py-3 rounded-xl border bg-gray-50 dark:bg-gray-700">
                </div>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="tradeType" value="Buy" checked class="sr-only"><span class="px-6 py-3 rounded-xl bg-green-500 text-white font-bold">Buy</span></label>
                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="tradeType" value="Sell" class="sr-only"><span class="px-6 py-3 rounded-xl bg-red-500 text-white font-bold">Sell</span></label>
                </div>
                <textarea id="tradeNotes" rows="2" placeholder="Notas..." class="w-full px-4 py-3 rounded-xl border bg-gray-50 dark:bg-gray-700"></textarea>
                <div class="flex justify-end gap-3">
                    <button type="button" id="deleteTrade" class="hidden px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl">Excluir</button>
                    <button type="submit" id="saveTradeBtn" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold rounded-xl">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { /* SEU CONFIG */ };
        const appId = 'meu-diario-de-trades';
        let app, db, auth, userId, operationsCollection;
        let currentTrades = [], equityChartInstance = null, currentEditingTradeId = null;
        let currentDate = new Date();
        const months = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

        const els = {
            monthYear: document.getElementById('currentMonthYear'),
            calendar: document.getElementById('calendarGrid'),
            modal: document.getElementById('tradeModal'), close: document.getElementById('closeModal'),
            form: document.getElementById('tradeForm'), amount: document.getElementById('tradeAmount'),
            contracts: document.getElementById('tradeContracts'), asset: document.getElementById('tradeAsset'),
            notes: document.getElementById('tradeNotes'), deleteBtn: document.getElementById('deleteTrade'),
            saveBtn: document.getElementById('saveTradeBtn'), dailyList: document.getElementById('dailyTradesList'),
            formTitle: document.getElementById('formTitle'),
            net: document.getElementById('netResult'), total: document.getElementById('totalTrades'),
            win: document.getElementById('winRate'), avg: document.getElementById('avgProfitLoss'),
            todayBalance: document.getElementById('todayBalance'), weekBalance: document.getElementById('weekBalance'),
            monthBalance: document.getElementById('monthBalance'), biggestGain: document.getElementById('biggestGain'),
            biggestLoss: document.getElementById('biggestLoss'),
            equityInput: document.getElementById('initialEquity'), equityBtn: document.getElementById('updateEquityChart'),
            equityCanvas: document.getElementById('equityChart').getContext('2d'),
            analysisAsset: document.getElementById('analysisByAsset'), analysisType: document.getElementById('analysisByType')
        };

        // === CALENDÁRIO + VALORES CENTRALIZADOS ===
        function renderCalendar() {
            els.calendar.innerHTML = '';
            const y = currentDate.getFullYear(), m = currentDate.getMonth();
            els.monthYear.textContent = `${months[m]} ${y}`;
            const first = new Date(y, m, 1).getDay(), days = new Date(y, m+1, 0).getDate();

            const monthTrades = currentTrades.filter(t => t.date?.startsWith(`${y}-${String(m+1).padStart(2,'0')}`));
            const daySum = {};
            monthTrades.forEach(t => { const d = t.date.split('-')[2]; daySum[d] = (daySum[d] || 0) + parseFloat(t.amount); });

            // hoje / semana
            const today = new Date().toISOString().slice(0,10);
            const weekStart = new Date(); weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekStartStr = weekStart.toISOString().slice(0,10);

            let todayBal = 0, weekBal = 0, monthBal = 0, maxGain = -Infinity, maxLoss = Infinity;
            currentTrades.forEach(t => {
                const amt = parseFloat(t.amount);
                if (t.date === today) todayBal += amt;
                if (t.date >= weekStartStr) { weekBal += amt; if (amt > maxGain) maxGain = amt; if (amt < maxLoss) maxLoss = amt; }
                if (t.date.startsWith(`${y}-${String(m+1).padStart(2,'0')}`)) monthBal += amt;
            });
            els.todayBalance.textContent = `R$ ${todayBal.toFixed(2)}`; els.todayBalance.className = todayBal>=0 ? 'text-3xl font-black text-green-600' : 'text-3xl font-black text-red-600';
            els.weekBalance.textContent = `R$ ${weekBal.toFixed(2)}`; els.weekBalance.className = weekBal>=0 ? 'text-3xl font-black text-blue-600' : 'text-3xl font-black text-red-600';
            els.monthBalance.textContent = `R$ ${monthBal.toFixed(2)}`; els.monthBalance.className = monthBal>=0 ? 'text-3xl font-black text-purple-600' : 'text-3xl font-black text-red-600';
            els.biggestGain.textContent = maxGain > -Infinity ? `R$ ${maxGain.toFixed(2)}` : 'R$ 0,00';
            els.biggestLoss.textContent = maxLoss < Infinity ? `R$ ${maxLoss.toFixed(2)}` : 'R$ 0,00';

            for (let i = 0; i < first; i++) addDay();
            for (let d = 1; d <= days; d++) {
                const date = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const sum = (daySum[d] || 0);
                const el = addDay(d, date, !!daySum[d], sum);
                if (daySum[d]) el.classList.add('has-trade');
            }
            updateSummary(monthTrades);
        }
        function addDay(num='', date='', has=false, result=0) {
            const div = document.createElement('div');
            div.className = 'day-box border-r border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700/50 cursor-pointer';
            if (num) {
                div.innerHTML = `
                    <span class="absolute top-1 left-1 text-xs font-bold text-gray-500 dark:text-gray-400">${num}</span>
                    ${has ? `<div class="value-box ${result>=0?'':'loss'}">R$ ${Math.abs(result).toFixed(2)}</div>` : ''}
                `;
                div.onclick = () => openModal(date);
            }
            els.calendar.appendChild(div);
            return div;
        }

        function updateSummary(trades) {
            const net = trades.reduce((a,t)=>a+parseFloat(t.amount),0);
            const wins = trades.filter(t=>parseFloat(t.amount)>0).length;
            const total = trades.length;
            const avg = total ? net/total : 0;
            els.net.textContent = `R$ ${net.toFixed(2)}`;
            els.net.className = net>=0 ? 'text-3xl font-black text-white' : 'text-3xl font-black text-white';
            els.total.textContent = total;
            els.win.textContent = total ? `${Math.round(wins/total*100)}%` : '0%';
            els.avg.textContent = `R$ ${avg.toFixed(2)}`;
        }

        // === GRÁFICO COM ÁREA VERMELHA ABAIXO DE ZERO ===
        function updateEquityChart() {
            const start = parseFloat(els.equityInput.value)||0;
            const daily = {};
            [...currentTrades].sort((a,b)=>a.date.localeCompare(b.date)).forEach(t=>{
                daily[t.date] = (daily[t.date]||0) + parseFloat(t.amount);
            });
            const labels = ['Início'], data = [start];
            let bal = start;
            Object.keys(daily).sort().forEach(d=>{ bal+=daily[d]; labels.push(d); data.push(+bal.toFixed(2)); });

            if (equityChartInstance) equityChartInstance.destroy();
            equityChartInstance = new Chart(els.equityCanvas, {
                type:'line',
                data:{
                    labels, datasets:[{
                        label:'Patrimônio', data,
                        borderColor:'#10b981', backgroundColor: ctx => {
                            const chart = ctx.chart;
                            const {ctx: canvasCtx, data: chartData} = chart;
                            const gradient = canvasCtx.createLinearGradient(0,0,0,chart.height);
                            const zeroY = chart.scales.y.getPixelForValue(0);
                            gradient.addColorStop(0, 'rgba(34,197,94,0.2)');
                            gradient.addColorStop(zeroY/chart.height, 'rgba(34,197,94,0.2)');
                            gradient.addColorStop(zeroY/chart.height, 'rgba(239,68,68,0.2)');
                            gradient.addColorStop(1, 'rgba(239,68,68,0.2)');
                            return gradient;
                        },
                        fill:true, tension:0.3
                    }]
                },
                options:{responsive:true, scales:{y:{ticks:{callback:v=>`R$ ${v}`}}}}
            });
        }
        els.equityBtn.onclick = updateEquityChart;

        // === ANÁLISE CORRIGIDA ===
        function updateAnalysis() {
            const byAsset = {}, byType = {Buy:{total:0,count:0,wins:0,losses:0,contracts:0}, Sell:{total:0,count:0,wins:0,losses:0,contracts:0}};
            currentTrades.forEach(t=>{
                const a = t.asset||'Outro', typ = t.type, amt = parseFloat(t.amount), c = t.contracts||1;
                if (!byAsset[a]) byAsset[a] = {total:0,count:0,wins:0,losses:0,contracts:0};
                byAsset[a].total += amt; byAsset[a].count++; byAsset[a].contracts += c;
                if (amt>0) byAsset[a].wins++; else byAsset[a].losses++;

                byType[typ].total += amt; byType[typ].count++; byType[typ].contracts += c;
                if (amt>0) byType[typ].wins++; else byType[typ].losses++;
            });

            const card = (title, d) => {
                const winRate = d.count ? Math.round(d.wins/d.count*100) : 0;
                return `<div class="p-4 bg-gradient-to-r from-blue-500/10 to-cyan-500/10 rounded-2xl border border-blue-200 dark:border-cyan-800">
                    <div class="flex justify-between"><span class="font-bold">${title}</span>
                    <span class="font-black text-xl ${d.total>=0?'text-green-600':'text-red-600'}">R$ ${d.total.toFixed(2)}</span></div>
                    <div class="text-xs mt-1 opacity-80">${d.wins}W / ${d.losses}L (${winRate}%) • ${d.contracts} contratos</div>
                </div>`;
            };

            els.analysisAsset.innerHTML = Object.keys(byAsset).length ? '' : '<p class="text-gray-500">Sem dados</p>';
            Object.entries(byAsset).sort((a,b)=>b[1].total-a[1].total).forEach(([k,v])=>els.analysisAsset.innerHTML+=card(k,v));

            els.analysisType.innerHTML = '';
            ['Buy','Sell'].forEach(t=>els.analysisType.innerHTML += card(t, byType[t]));
        }

        // === MODAL, ABAS, TEMA, FIREBASE (100% IGUAL) ===
        let currentEditingDate = null;
        function openModal(date) { /* ... mesmo código ... */ }
        // (código do modal, abas, tema, firebase idêntico ao anterior)

        document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click',()=>{ /* ... */ }));
        document.getElementById('prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
        document.getElementById('nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };

        app = initializeApp(firebaseConfig);
        db = getFirestore(app); auth = getAuth(app);
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                operationsCollection = collection(db, `artifacts/${appId}/public/data/operations`);
                onSnapshot(query(operationsCollection), snap => {
                    currentTrades = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    renderCalendar();
                    if (!document.getElementById('patrimonio').classList.contains('hidden')) updateEquityChart();
                    if (!document.getElementById('analise').classList.contains('hidden')) updateAnalysis();
                });
            } else signInAnonymously(auth);
        });
        signInAnonymously(auth);
    </script>
</body>
</html>
