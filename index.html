<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Diário de Trades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui'] },
                    animation: { 'pulse-soft': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        .has-trade::before {
            content: '';
            @apply absolute inset-0 rounded-lg ring-4 ring-green-500/30 animate-pulse-soft;
        }
        .day-result { @apply font-bold text-lg transition-all; }
        .modal-enter { @apply opacity-0 scale-95; }
        .modal-enter-active { @apply opacity-100 scale-100 transition-all duration-300; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">

        <!-- HEADER -->
        <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
            <div class="flex items-center gap-3">
                <i class="fas fa-chart-line text-4xl text-blue-600 dark:text-blue-400"></i>
                <h1 class="text-3xl md:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500">
                    Diário de Trades
                </h1>
            </div>
            <div class="flex items-center gap-3">
                <button id="themeToggle" class="p-3 rounded-xl bg-white/80 dark:bg-gray-800/80 backdrop-blur shadow-lg hover:shadow-xl transition-all">
                    <i class="fas fa-sun text-yellow-500" id="sun"></i>
                    <i class="fas fa-moon hidden text-indigo-400" id="moon"></i>
                </button>
                <nav class="flex bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-xl shadow-lg">
                    <button data-tab="diario"   class="tab-btn active px-5 py-3 font-semibold">Diário</button>
                    <button data-tab="patrimonio" class="tab-btn px-5 py-3 font-semibold">Patrimônio</button>
                    <button data-tab="analise"  class="tab-btn px-5 py-3 font-semibold">Análise</button>
                </nav>
            </div>
        </header>

        <!-- ABA DIÁRIO -->
        <section id="diario" class="tab-content space-y-6">
            <!-- CONTROLES CALENDÁRIO -->
            <div class="flex justify-between items-center p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl">
                <button id="prevMonth" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-chevron-left"></i></button>
                <h2 id="currentMonthYear" class="text-2xl font-bold text-gray-800 dark:text-gray-200"></h2>
                <button id="nextMonth" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- RESUMO MENSAL -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-5 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg text-white">
                    <i class="fas fa-wallet text-2xl mb-2"></i>
                    <p class="text-sm opacity-90">Líquido</p>
                    <p id="netResult" class="text-3xl font-black">R$ 0,00</p>
                </div>
                <div class="p-5 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl shadow-lg text-white">
                    <i class="fas fa-exchange-alt text-2xl mb-2"></i>
                    <p class="text-sm opacity-90">Trades</p>
                    <p id="totalTrades" class="text-3xl font-black">0</p>
                </div>
                <div class="p-5 bg-gradient-to-br from-pink-500 to-rose-600 rounded-2xl shadow-lg text-white">
                    <i class="fas fa-trophy text-2xl mb-2"></i>
                    <p class="text-sm opacity-90">Win Rate</p>
                    <p id="winRate" class="text-3xl font-black">0%</p>
                </div>
                <div class="p-5 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl shadow-lg text-white">
                    <i class="fas fa-calculator text-2xl mb-2"></i>
                    <p class="text-sm opacity-90">Média</p>
                    <p id="avgProfitLoss" class="text-3xl font-black">R$ 0,00</p>
                </div>
            </div>

            <!-- CALENDÁRIO -->
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl overflow-hidden">
                <div class="grid grid-cols-7 text-center font-bold text-sm uppercase tracking-wider bg-gradient-to-r from-blue-600 to-cyan-500 text-white py-4">
                    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7"></div>
            </div>
        </section>

        <!-- ABA PATRIMÔNIO -->
        <section id="patrimonio" class="tab-content hidden">
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="fas fa-chart-line text-green-500"></i> Evolução do Patrimônio</h2>
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="number" id="initialEquity" placeholder="Patrimônio inicial" class="px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50">
                    <button id="updateEquityChart" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold rounded-xl hover:shadow-lg transition">Atualizar</button>
                </div>
                <canvas id="equityChart" class="max-h-96"></canvas>
            </div>
        </section>

        <!-- ABA ANÁLISE -->
        <section id="analise" class="tab-content hidden space-y-8">
            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-coins text-yellow-500"></i> Por Ativo</h3>
                    <div id="analysisByAsset" class="space-y-3"></div>
                </div>
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-arrows-alt-h text-purple-500"></i> Por Tipo</h3>
                    <div id="analysisByType" class="space-y-3"></div>
                </div>
            </div>
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-search-dollar text-cyan-500"></i> Detalhado por Ativo</h3>
                <div id="detailedAnalysis" class="space-y-4"></div>
            </div>
        </section>
    </div>

    <!-- MODAL -->
    <div id="tradeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl w-full max-w-lg p-8 modal-enter-active">
            <button id="closeModal" class="absolute top-4 right-6 text-3xl text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">&times;</button>
            <h3 class="text-2xl font-bold mb-6">Operações do Dia</h3>
            <div id="dailyTradesList" class="max-h-40 overflow-y-auto mb-6 border-y border-gray-200 dark:border-gray-700 py-2"></div>
            <h4 id="formTitle" class="text-xl font-bold mb-4">Adicionar Operação</h4>
            <form id="tradeForm" class="space-y-5">
                <input type="hidden" id="tradeDate">
                <div>
                    <label class="block font-semibold mb-2">Valor (R$)</label>
                    <input type="number" step="0.01" id="tradeAmount" required placeholder="150.00" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Ativo</label>
                        <select id="tradeAsset" required class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50">
                            <option value="">Escolha...</option>
                            <option>XAUUSD</option>
                            <option>S&P500</option>
                            <option>Nasdaq</option>
                            <option>Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Contratos</label>
                        <input type="number" id="tradeContracts" min="1" value="1" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50">
                    </div>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Tipo</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="tradeType" value="Buy" checked class="sr-only">
                            <span class="px-6 py-3 rounded-xl bg-green-500 text-white font-bold shadow-md">Buy</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="tradeType" value="Sell" class="sr-only">
                            <span class="px-6 py-3 rounded-xl bg-red-500 text-white font-bold shadow-md">Sell</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Notas (opcional)</label>
                    <textarea id="tradeNotes" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50" placeholder="Rompimento de topo..."></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="deleteTrade" class="hidden px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-md transition">Excluir</button>
                    <button type="submit" id="saveTradeBtn" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SCRIPT (100% ORIGINAL + VISUAL UPGRADES) -->
    <script type="module">
        // === TODAS AS IMPORTAÇÕES E CONFIG DO FIREBASE (IGUAIS) ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYXehc5ijr11GD029ph7-6a0oVy9ddcKY",
            authDomain: "meu-diario-de-trades.firebaseapp.com",
            projectId: "meu-diario-de-trades",
            storageBucket: "meu-diario-de-trades.firebasestorage.app",
            messagingSenderId: "744192474673",
            appId: "1:744192474673:websocket:c5adf1d9526b81deed1f10",
        };
        const appId = 'meu-diario-de-trades';

        let app, db, auth, userId, operationsCollection;
        let currentTrades = [];
        let equityChartInstance = null;
        let currentEditingTradeId = null;

        // === ELEMENTOS DOM (mesmos IDs) ===
        const els = {
            monthYear: document.getElementById('currentMonthYear'),
            calendar: document.getElementById('calendarGrid'),
            modal: document.getElementById('tradeModal'),
            close: document.getElementById('closeModal'),
            form: document.getElementById('tradeForm'),
            amount: document.getElementById('tradeAmount'),
            contracts: document.getElementById('tradeContracts'),
            asset: document.getElementById('tradeAsset'),
            notes: document.getElementById('tradeNotes'),
            deleteBtn: document.getElementById('deleteTrade'),
            saveBtn: document.getElementById('saveTradeBtn'),
            dailyList: document.getElementById('dailyTradesList'),
            formTitle: document.getElementById('formTitle'),
            net: document.getElementById('netResult'),
            total: document.getElementById('totalTrades'),
            win: document.getElementById('winRate'),
            avg: document.getElementById('avgProfitLoss'),
            equityInput: document.getElementById('initialEquity'),
            equityBtn: document.getElementById('updateEquityChart'),
            equityCanvas: document.getElementById('equityChart').getContext('2d'),
            analysisAsset: document.getElementById('analysisByAsset'),
            analysisType: document.getElementById('analysisByType'),
            detailed: document.getElementById('detailedAnalysis'),
        };

        // === CALENDÁRIO ===
        let currentDate = new Date();
        const months = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

        function renderCalendar() {
            els.calendar.innerHTML = '';
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            els.monthYear.textContent = `${months[m]} ${y}`;

            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m+1, 0).getDate();

            const monthTrades = currentTrades.filter(t => t.date?.startsWith(`${y}-${String(m+1).padStart(2,'0')}`));
            const daySum = {};
            monthTrades.forEach(t => {
                const d = t.date.split('-')[2];
                daySum[d] = (daySum[d] || 0) + parseFloat(t.amount);
            });

            for (let i = 0; i < first; i++) addDay();
            for (let d = 1; d <= days; d++) {
                const date = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const sum = (daySum[d] || 0).toFixed(2);
                const has = daySum[d] !== undefined;
                const el = addDay(d, date, has, sum);
                if (has) el.classList.add('has-trade');
            }
            updateSummary(monthTrades);
        }
        function addDay(num='', date='', hasTrade=false, result='') {
            const div = document.createElement('div');
            div.className = 'relative aspect-square p-3 border-r border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition';
            if (num) {
                div.innerHTML = `
                    <span class="absolute top-2 right-2 text-xs font-bold text-gray-500 dark:text-gray-400">${num}</span>
                    ${hasTrade ? `<div class="day-result ${result>=0?'text-green-600':'text-red-600'}">R$ ${Math.abs(result)}</div>` : ''}
                `;
                div.onclick = () => openModal(date);
            }
            els.calendar.appendChild(div);
            return div;
        }

        function updateSummary(trades) {
            const net = trades.reduce((a,t)=>a+parseFloat(t.amount),0);
            const wins = trades.filter(t=>parseFloat(t.amount)>0).length;
            const total = trades.length;
            const avg = total ? net/total : 0;

            els.net.textContent = `R$ ${net.toFixed(2)}`;
            els.net.className = net>=0 ? 'text-3xl font-black text-white' : 'text-3xl font-black text-white';
            els.total.textContent = total;
            els.win.textContent = total ? `${Math.round(wins/total*100)}%` : '0%';
            els.avg.textContent = `R$ ${avg.toFixed(2)}`;
        }

        // === MODAL ===
        let currentEditingDate = null;
        function openModal(date) {
            currentEditingDate = date;
            document.getElementById('tradeDate').value = date;
            resetForm();
            const dayTrades = currentTrades.filter(t=>t.date===date).sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));
            els.dailyList.innerHTML = dayTrades.length ? '' : '<p class="text-center text-gray-500 py-4">Nenhum trade</p>';
            dayTrades.forEach(t => {
                const color = parseFloat(t.amount)>=0 ? 'text-green-600' : 'text-red-600';
                els.dailyList.innerHTML += `
                    <div class="flex justify-between items-center p-3 hover:bg-gray-100 dark:hover:bg-gray-700/50 cursor-pointer rounded-lg" data-id="${t.id}">
                        <div><span class="font-bold ${color}">R$ ${Math.abs(t.amount).toFixed(2)}</span>
                        <span class="text-xs ml-2 opacity-70">(${t.contracts||1}c × ${t.asset||'?'}/${t.type[0]})</span></div>
                        <i class="fas fa-edit text-gray-500"></i>
                    </div>`;
            });
            els.dailyList.querySelectorAll('[data-id]').forEach(el=>el.onclick=e=>loadTradeForEdit(e.currentTarget.dataset.id));
            els.modal.classList.remove('hidden');
            setTimeout(()=>els.modal.querySelector('.modal-enter-active').classList.add('modal-enter-active'),10);
            els.amount.focus();
        }
        function closeModal() {
            els.modal.querySelector('.modal-enter-active').classList.replace('modal-enter-active','modal-enter');
            setTimeout(()=>els.modal.classList.add('hidden'),300);
        }
        els.close.onclick = closeModal;
        els.modal.onclick = e => e.target===els.modal && closeModal();

        function resetForm() {
            els.form.reset();
            els.contracts.value = 1;
            els.form.querySelector('[value="Buy"]').checked = true;
            currentEditingTradeId = null;
            els.deleteBtn.classList.add('hidden');
            els.saveBtn.textContent = 'Salvar';
            els.formTitle.textContent = 'Adicionar Operação';
        }
        function loadTradeForEdit(id) {
            const t = currentTrades.find(x=>x.id===id);
            els.amount.value = t.amount;
            els.contracts.value = t.contracts||1;
            els.asset.value = t.asset||'';
            els.notes.value = t.notes||'';
            els.form.querySelector(`[value="${t.type}"]`).checked = true;
            currentEditingTradeId = id;
            els.saveBtn.textContent = 'Atualizar';
            els.formTitle.textContent = 'Editar Operação';
            els.deleteBtn.classList.remove('hidden');
            els.dailyList.querySelectorAll('[data-id]').forEach(el=>el.classList.toggle('bg-blue-100 dark:bg-blue-900/50', el.dataset.id===id));
        }

        // === FORM SUBMIT (100% ORIGINAL) ===
        els.form.onsubmit = async e => {
            e.preventDefault();
            const amount = parseFloat(els.amount.value);
            if (isNaN(amount) || !els.asset.value) return;

            const data = {
                userId, date: currentEditingDate, amount,
                contracts: parseInt(els.contracts.value)||1,
                asset: els.asset.value,
                type: els.form.querySelector('[name="tradeType"]:checked').value,
                notes: els.notes.value
            };

            try {
                if (currentEditingTradeId) {
                    await setDoc(doc(operationsCollection, currentEditingTradeId), {...data, updatedAt: new Date().toISOString()}, {merge:true});
                } else {
                    data.createdAt = new Date().toISOString();
                    await addDoc(operationsCollection, data);
                }
                resetForm();
                openModal(currentEditingDate);
            } catch (err) { console.error(err); }
        };
        els.deleteBtn.onclick = async () => {
            if (!currentEditingTradeId) return;
            await deleteDoc(doc(operationsCollection, currentEditingTradeId));
            resetForm();
            openModal(currentEditingDate);
        };

        // === GRÁFICO PATRIMÔNIO ===
        function updateEquityChart() {
            const start = parseFloat(els.equityInput.value)||0;
            const daily = {};
            [...currentTrades].sort((a,b)=>a.date.localeCompare(b.date)).forEach(t=>{
                daily[t.date] = (daily[t.date]||0) + parseFloat(t.amount);
            });
            const labels = ['Início'];
            const data = [start];
            let bal = start;
            Object.keys(daily).sort().forEach(d=>{ bal+=daily[d]; labels.push(d); data.push(+bal.toFixed(2)); });

            if (equityChartInstance) equityChartInstance.destroy();
            equityChartInstance = new Chart(els.equityCanvas, {
                type:'line', data:{labels, datasets:[{label:'Patrimônio', data, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)', fill:true, tension:0.3}]},
                options:{responsive:true, scales:{y:{ticks:{callback:v=>`R$ ${v}`}}}}
            });
        }
        els.equityBtn.onclick = updateEquityChart;

        // === ANÁLISE (MESMA LÓGICA, VISUAL MELHORADO) ===
        function updateAnalysis() {
            const byAsset = {}, byType = {Buy:{}, Sell:{}};
            currentTrades.forEach(t=>{
                const a = t.asset||'N/A', typ = t.type, amt = parseFloat(t.amount), c = t.contracts||1;
                // por ativo
                if (!byAsset[a]) byAsset[a] = {total:0, count:0, wins:0, losses:0, contracts:0};
                byAsset[a].total += amt; byAsset[a].count++; byAsset[a].contracts += c;
                if (amt>0) byAsset[a].wins++; else byAsset[a].losses++;
                // por tipo
                if (!byType[typ]) byType[typ] = {total:0, count:0, wins:0, losses:0, contracts:0};
                byType[typ].total += amt; byType[typ].count++; byType[typ].contracts += c;
                if (amt>0) byType[typ].wins++; else byType[typ].losses++;
            });

            const card = (title, total, wins, losses, contracts) => {
                const winRate = total ? Math.round(wins/total*100) : 0;
                return `<div class="p-4 bg-gradient-to-r from-blue-500/10 to-cyan-500/10 rounded-2xl border border-blue-200 dark:border-cyan-800">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-lg">${title}</span>
                        <span class="font-black text-2xl ${total>=0?'text-green-600':'text-red-600'}">R$ ${Math.abs(total).toFixed(2)}</span>
                    </div>
                    <div class="text-xs mt-2 opacity-80">${wins}W/${losses}L (${winRate}%) • ${contracts} contratos</div>
                </div>`;
            };

            els.analysisAsset.innerHTML = Object.keys(byAsset).length ? '' : '<p class="text-gray-500">Sem dados</p>';
            Object.entries(byAsset).sort((a,b)=>b[1].total-a[1].total).forEach(([k,v])=>els.analysisAsset.innerHTML += card(k, v.count, v.wins, v.losses, v.contracts));

            els.analysisType.innerHTML = '';
            ['Buy','Sell'].forEach(t=> {
                const d = byType[t] || {total:0,count:0,wins:0,losses:0,contracts:0};
                els.analysisType.innerHTML += card(t, d.count, d.wins, d.losses, d.contracts);
            });

            els.detailed.innerHTML = Object.keys(byAsset).length ? '' : '<p class="text-gray-500">Sem dados</p>';
            Object.entries(byAsset).sort((a,b)=>b[1].total-a[1].total).forEach(([asset, d])=>{
                els.detailed.innerHTML += `
                    <details class="bg-white/80 dark:bg-gray-800/80 rounded-2xl shadow-lg">
                        <summary class="p-5 font-bold cursor-pointer flex justify-between">
                            <span>${asset}</span>
                            <span class="${d.total>=0?'text-green-600':'text-red-600'}">R$ ${d.total.toFixed(2)}</span>
                        </summary>
                        <div class="p-5 space-y-3 border-t dark:border-gray-700">
                            ${card('Buy', d.wins+d.losses, d.wins, d.losses, d.contracts)}
                            ${card('Sell', d.wins+d.losses, d.wins, d.losses, d.contracts)}
                        </div>
                    </details>`;
            });
        }

        // === ABAS ===
        document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click',()=>{
            document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));
            document.getElementById(b.dataset.tab).classList.remove('hidden');
            if (b.dataset.tab==='patrimonio') updateEquityChart();
            if (b.dataset.tab==='analise') updateAnalysis();
        }));

        // === TEMA ===
        const themeBtn = document.getElementById('themeToggle');
        const sun = document.getElementById('sun'), moon = document.getElementById('moon');
        themeBtn.onclick = () => {
            const dark = !document.documentElement.classList.toggle('dark');
            sun.classList.toggle('hidden', !dark);
            moon.classList.toggle('hidden', dark);
            localStorage.setItem('theme', dark?'dark':'light');
            if (equityChartInstance) updateEquityChart();
        };
        if (localStorage.getItem('theme')==='dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark'); moon.classList.remove('hidden'); sun.classList.add('hidden');
        }

        // === NAVEGAÇÃO CALENDÁRIO ===
        document.getElementById('prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
        document.getElementById('nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };

        // === FIREBASE (100% ORIGINAL) ===
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async user => {
            if (user) {
                userId = user.uid;
                operationsCollection = collection(db, `artifacts/${appId}/public/data/operations`);
                onSnapshot(query(operationsCollection), snap => {
                    currentTrades = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    renderCalendar();
                    if (!document.getElementById('patrimonio').classList.contains('hidden')) updateEquityChart();
                    if (!document.getElementById('analise').classList.contains('hidden')) updateAnalysis();
                });
            } else {
                signInAnonymously(auth);
            }
        });
        signInAnonymously(auth).catch(console.error);
    </script>
</body>
</html>
