<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Diário de Trades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Estilos do novo layout para o calendário */
        .day-box { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            font-size: 0.75rem; 
        }
        .value-box {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 80%; 
            height: 60%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 0.8rem; 
            border-radius: 0.5rem; 
            border: 1px solid rgba(0,0,0,0.1);
            background: rgba(34,197,94,0.08); 
            color: #166534;
        }
        .dark .value-box {
             border: 1px solid rgba(255,255,255,0.1);
             background: rgba(34,197,94,0.1);
             color: #6ee7b7;
        }
        .value-box.loss { 
            background: rgba(239,68,68,0.08); 
            color: #991b1b; 
        }
         .dark .value-box.loss { 
            background: rgba(239,68,68,0.1); 
            color: #fca5a5; 
        }
        .has-trade::after { 
            content: ''; 
            position: absolute; 
            top: 0.25rem; 
            right: 0.25rem; 
            width: 0.5rem; 
            height: 0.5rem; 
            background: linear-gradient(to bottom right, #10b981, #059669); 
            border-radius: 50%; 
            box-shadow: 0 0 0.25rem rgba(16,185,129,0.5); 
        }
        /* Estilo para botões de rádio Buy/Sell no modal */
        input[name="tradeType"]:checked + span {
            filter: brightness(1.2);
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-gray-100">
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">

        <!-- HEADER -->
        <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
            <div class="flex items-center gap-3">
                <i class="fas fa-chart-line text-4xl text-blue-600 dark:text-blue-400"></i>
                <h1 class="text-3xl md:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500">Diário de Trades</h1>
            </div>
            <div class="flex items-center gap-3">
                <button id="themeToggle" class="p-3 rounded-xl bg-white/80 dark:bg-gray-800/80 backdrop-blur shadow-lg hover:shadow-xl transition-all">
                    <i class="fas fa-sun text-yellow-500" id="sun"></i>
                    <i class="fas fa-moon hidden text-indigo-400" id="moon"></i>
                </button>
                <nav class="flex bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-xl shadow-lg overflow-hidden">
                    <button data-tab="diario" class="tab-btn active px-6 py-3 font-semibold bg-white dark:bg-gray-700 text-blue-600">Diário</button>
                    <button data-tab="patrimonio" class="tab-btn px-6 py-3 font-semibold text-gray-600 dark:text-gray-400">Patrimônio</button>
                    <button data-tab="analise" class="tab-btn px-6 py-3 font-semibold text-gray-600 dark:text-gray-400">Análise</button>
                </nav>
            </div>
        </header>

        <!-- DIÁRIO -->
        <section id="diario" class="tab-content space-y-6">
            <div class="flex justify-between items-center p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl">
                <button id="prevMonth" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-chevron-left"></i></button>
                <h2 id="currentMonthYear" class="text-2xl font-bold text-gray-800 dark:text-gray-200"></h2>
                <button id="nextMonth" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- RESUMO MENSAL -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-2 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg text-white text-center">
                    <i class="fas fa-wallet text-xl mb-1 block mx-auto"></i>
                    <p class="text-xs opacity-90">Líquido</p>
                    <p id="netResult" class="text-lg font-black">R$ 0,00</p>
                </div>
                <div class="p-4 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl shadow-lg text-white text-center">
                    <i class="fas fa-exchange-alt text-2xl mb-2 block mx-auto"></i>
                    <p class="text-sm opacity-90">Trades</p>
                    <p id="totalTrades" class="text-2xl font-black">0</p>
                </div>
                <div class="p-4 bg-gradient-to-br from-pink-500 to-rose-600 rounded-2xl shadow-lg text-white text-center">
                    <i class="fas fa-trophy text-2xl mb-2 block mx-auto"></i>
                    <p class="text-sm opacity-90">Win Rate</p>
                    <p id="winRate" class="text-2xl font-black">0%</p>
                </div>
                <div class="p-4 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl shadow-lg text-white text-center">
                    <i class="fas fa-calculator text-2xl mb-2 block mx-auto"></i>
                    <p class="text-sm opacity-90">Média</p>
                    <p id="avgProfitLoss" class="text-2xl font-black">R$ 0,00</p>
                </div>
            </div>

            <!-- CALENDÁRIO -->
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl overflow-hidden">
                <div class="grid grid-cols-7 text-center font-bold text-sm uppercase tracking-wider bg-gradient-to-r from-blue-600 to-cyan-500 text-white py-4">
                    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 p-2 gap-1"></div>
            </div>

            <!-- SALDOS -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl text-center">
                    <p class="text-sm opacity-70 mb-2">Hoje</p>
                    <p id="todayBalance" class="text-2xl font-black text-green-600">R$ 0,00</p>
                </div>
                <div class="p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl text-center">
                    <p class="text-sm opacity-70 mb-2">Semana</p>
                    <p id="weekBalance" class="text-2xl font-black text-blue-600">R$ 0,00</p>
                </div>
                <div class="p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-xl text-center">
                    <p class="text-sm opacity-70 mb-2">Mês</p>
                    <p id="monthBalance" class="text-2xl font-black text-purple-600">R$ 0,00</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg text-white text-center">
                    <p class="text-sm opacity-90 mb-2">Maior Gain Semana</p>
                    <p id="biggestGain" class="text-2xl font-black">R$ 0,00</p>
                </div>
                <div class="p-4 bg-gradient-to-br from-rose-500 to-red-600 rounded-2xl shadow-lg text-white text-center">
                    <p class="text-sm opacity-90 mb-2">Maior Loss Semana</p>
                    <p id="biggestLoss" class="text-2xl font-black">R$ 0,00</p>
                </div>
            </div>
        </section>

        <!-- PATRIMÔNIO -->
        <section id="patrimonio" class="tab-content hidden">
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-5">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="fas fa-chart-line text-green-500"></i> Evolução do Patrimônio</h2>
                <div class="flex flex-wrap gap-4 mb-6 items-center">
                    <label class="text-sm font-medium">Inicial (R$):</label>
                    <input type="number" id="initialEquity" value="0" class="px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50 w-32">
                    <button id="updateEquityChart" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold rounded-xl hover:shadow-lg transition">Atualizar</button>
                </div>
                <div class="relative h-64 md:h-96">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
        </section>

        <!-- ANÁLISE -->
        <section id="analise" class="tab-content hidden space-y-8">
            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-5">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-coins text-yellow-500"></i> Por Ativo (Lucro Total / Win Rate)</h3>
                    <div id="analysisByAsset" class="space-y-3"></div>
                </div>
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-5">
                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-arrows-alt-h text-purple-500"></i> Por Tipo (Buy/Sell)</h3>
                    <div id="analysisByType" class="space-y-3"></div>
                </div>
            </div>
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-2xl shadow-2xl p-5">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-search-dollar text-cyan-500"></i> Detalhado por Ativo</h3>
                <div id="detailedAnalysis" class="space-y-4"></div>
            </div>
        </section>
    </div>

    <!-- MODAL -->
    <div id="tradeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <!-- Conteúdo do Modal -->
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl w-full max-w-lg p-8 relative transform scale-95 transition-all duration-300" id="modalContent">
            <button id="closeModal" class="absolute top-4 right-6 text-3xl text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">&times;</button>
            <h3 class="text-2xl font-bold mb-6">Operações do Dia</h3>
            <div id="dailyTradesList" class="max-h-40 overflow-y-auto mb-6 border border-gray-200 dark:border-gray-700 rounded-lg py-2"></div>
            <h4 id="formTitle" class="text-xl font-bold mb-4">Adicionar Operação</h4>
            <form id="tradeForm" class="space-y-4">
                <input type="hidden" id="tradeDate">
                <div>
                    <label class="block font-semibold mb-2">Valor (R$)</label>
                    <input type="number" step="0.01" id="tradeAmount" required placeholder="150.00 ou -50.00" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Ativo</label>
                        <select id="tradeAsset" required class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50">
                            <option value="">Selecione...</option>
                            <option value="XAUUSD">XAUUSD</option>
                            <option value="S&P500">S&P500</option>
                            <option value="Nasdaq">Nasdaq</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Contratos</label>
                        <input type="number" id="tradeContracts" min="1" value="1" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50">
                    </div>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Tipo</label>
                    <div class="flex gap-4">
                        <label class="cursor-pointer"><input type="radio" name="tradeType" value="Buy" checked class="sr-only"><span class="px-6 py-3 rounded-xl bg-green-500 text-white font-bold shadow-md hover:shadow-lg transition-all duration-200">Buy</span></label>
                        <label class="cursor-pointer"><input type="radio" name="tradeType" value="Sell" class="sr-only"><span class="px-6 py-3 rounded-xl bg-red-500 text-white font-bold shadow-md hover:shadow-lg transition-all duration-200">Sell</span></label>
                    </div>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Notas (opcional)</label>
                    <textarea id="tradeNotes" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50" placeholder="Ex: Rompimento de topo..."></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="deleteTrade" class="hidden px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-md transition">Excluir</button>
                    <button type="submit" id="saveTradeBtn" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase imports e config (exato do seu código original)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDYXehc5ijr11GD029ph7-6a0oVy9ddcKY",
            authDomain: "meu-diario-de-trades.firebaseapp.com",
            projectId: "meu-diario-de-trades",
            storageBucket: "meu-diario-de-trades.firebasestorage.app",
            messagingSenderId: "744192474673",
            appId: "1:744192474673:web:c5adf1d9526b81deed1f10",
            measurementId: "G-LM9V31W7BE"
        };
        const appId = 'meu-diario-de-trades';

        // Variáveis Globais
        let app, db, auth, userId, operationsCollection;
        let currentTrades = [];
        let equityChartInstance = null;
        let currentEditingTradeId = null;
        let currentDate = new Date();
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        // Elementos DOM (como no seu código)
        const els = {
            currentMonthYear: document.getElementById('currentMonthYear'),
            calendarGrid: document.getElementById('calendarGrid'),
            tradeModal: document.getElementById('tradeModal'),
            modalContent: document.getElementById('modalContent'), // Para animação de clique fora
            closeModal: document.getElementById('closeModal'),
            tradeForm: document.getElementById('tradeForm'),
            tradeAmount: document.getElementById('tradeAmount'),
            tradeContracts: document.getElementById('tradeContracts'),
            tradeAsset: document.getElementById('tradeAsset'),
            tradeNotes: document.getElementById('tradeNotes'),
            deleteTrade: document.getElementById('deleteTrade'),
            saveTradeBtn: document.getElementById('saveTradeBtn'),
            dailyTradesList: document.getElementById('dailyTradesList'),
            formTitle: document.getElementById('formTitle'),
            netResult: document.getElementById('netResult'),
            totalTrades: document.getElementById('totalTrades'),
            winRate: document.getElementById('winRate'),
            avgProfitLoss: document.getElementById('avgProfitLoss'),
            todayBalance: document.getElementById('todayBalance'),
            weekBalance: document.getElementById('weekBalance'),
            monthBalance: document.getElementById('monthBalance'),
            biggestGain: document.getElementById('biggestGain'),
            biggestLoss: document.getElementById('biggestLoss'),
            initialEquity: document.getElementById('initialEquity'),
            updateEquityChart: document.getElementById('updateEquityChart'),
            equityChart: document.getElementById('equityChart').getContext('2d'),
            analysisByAsset: document.getElementById('analysisByAsset'),
            analysisByType: document.getElementById('analysisByType'),
            detailedAnalysis: document.getElementById('detailedAnalysis')
        };

        let currentEditingDate = null;

        // --- Funções do Modal ---
        function openModal(date) {
            if (!date) return;
            currentEditingDate = date;
            resetForm();
            els.dailyTradesList.innerHTML = '';
            const tradesOfTheDay = currentTrades.filter(t => t.date === date).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
            if (tradesOfTheDay.length > 0) {
                tradesOfTheDay.forEach(trade => {
                    const amount = parseFloat(trade.amount);
                    const typeLabel = trade.type === 'Buy' ? 'B' : 'S';
                    const assetLabel = trade.asset || 'N/A';
                    const contracts = trade.contracts || 1;
                    const amountColor = amount >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                    els.dailyTradesList.innerHTML += `
                        <div class="p-3 mx-2 flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg transition" data-trade-id="${trade.id}">
                            <div>
                                <span class="font-bold ${amountColor}">R$ ${amount.toFixed(2)}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(${contracts}c, ${assetLabel}/${typeLabel})</span>
                            </div>
                            <i class="fas fa-pencil-alt text-xs text-gray-400"></i>
                        </div>
                    `;
                });
                els.dailyTradesList.querySelectorAll('[data-trade-id]').forEach(item => {
                    item.addEventListener('click', () => loadTradeForEdit(item.dataset.tradeId));
                });
            } else {
                els.dailyTradesList.innerHTML = '<p class="p-4 text-sm text-gray-400 dark:text-gray-500 text-center">Nenhuma operação neste dia.</p>';
            }
            els.tradeModal.classList.remove('hidden');
            setTimeout(() => els.modalContent.classList.add('scale-100'), 10);
            els.tradeAmount.focus();
        }

        function resetForm() {
            els.tradeForm.reset();
            els.tradeContracts.value = '1';
            els.tradeAsset.value = '';
            els.tradeNotes.value = '';
            document.querySelector('input[name="tradeType"][value="Buy"]').checked = true;
            currentEditingTradeId = null;
            els.deleteTrade.classList.add('hidden');
            els.saveTradeBtn.textContent = 'Salvar';
            els.formTitle.textContent = 'Adicionar Nova Operação';
        }

        function loadTradeForEdit(tradeId) {
            const trade = currentTrades.find(t => t.id === tradeId);
            if (!trade) return;
            els.tradeAmount.value = trade.amount;
            els.tradeContracts.value = trade.contracts || 1;
            els.tradeAsset.value = trade.asset || '';
            els.tradeNotes.value = trade.notes || '';
            document.querySelector(`input[name="tradeType"][value="${trade.type || 'Buy'}"]`).checked = true;
            currentEditingTradeId = tradeId;
            els.saveTradeBtn.textContent = 'Atualizar';
            els.formTitle.textContent = 'Editar Operação';
            els.deleteTrade.classList.remove('hidden');
            els.tradeAmount.focus();
        }

        function closeModal() {
            els.modalContent.classList.remove('scale-100');
            setTimeout(() => {
                els.tradeModal.classList.add('hidden');
                currentEditingDate = null;
                resetForm();
            }, 300); // Espera a animação de scale-out
        }
        els.closeModal.onclick = closeModal;
        els.tradeModal.addEventListener('click', (e) => { 
            if (e.target === els.tradeModal) closeModal(); 
        });

        // --- Funções do Calendário e Resumos ---
        function renderCalendar() {
            els.calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            els.currentMonthYear.textContent = `${monthNames[month]} ${year}`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const monthTrades = currentTrades.filter(t => {
                const [tYear, tMonth] = t.date.split('-').map(Number);
                return tYear === year && (tMonth - 1) === month;
            });

            const tradesByDay = {};
            monthTrades.forEach(trade => {
                const day = parseInt(trade.date.split('-')[2]);
                if (!tradesByDay[day]) tradesByDay[day] = [];
                tradesByDay[day].push(parseFloat(trade.amount));
            });

            // Dias em branco
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'day-box bg-gray-50 dark:bg-gray-800/50 opacity-50';
                els.calendarGrid.appendChild(emptyDay);
            }

            // Dias do mês
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayTrades = tradesByDay[day] || [];
                let dayResult = dayTrades.reduce((acc, val) => acc + val, 0);

                const dayEl = document.createElement('div');
                dayEl.className = 'day-box border border-gray-100 dark:border-gray-700/50 p-1 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all rounded-lg';
                dayEl.dataset.date = dateString;
                dayEl.innerHTML = `
                    <span class="absolute top-1 right-1 text-xs font-bold text-gray-500 dark:text-gray-400">${day}</span>
                    ${dayTrades.length > 0 ? `<div class="value-box ${dayResult >= 0 ? '' : 'loss'}">R$ ${Math.abs(dayResult).toFixed(2)}</div>` : ''}
                `;
                dayEl.addEventListener('click', () => openModal(dateString));
                if (dayTrades.length > 0) dayEl.classList.add('has-trade');
                els.calendarGrid.appendChild(dayEl);
            }

            updateSummary(monthTrades);
            updateBalances(); // Atualiza os saldos
        }

        function updateSummary(monthTrades) {
            const totalResult = monthTrades.reduce((acc, t) => acc + parseFloat(t.amount), 0);
            const winningTrades = monthTrades.filter(t => parseFloat(t.amount) > 0).length;
            const total = monthTrades.length;

            els.netResult.textContent = `R$ ${totalResult.toFixed(2)}`;
            els.netResult.className = 'text-lg font-black'; // A cor já vem do gradiente

            els.totalTrades.textContent = total;

            const winRate = total > 0 ? (winningTrades / total) * 100 : 0;
            els.winRate.textContent = `${winRate.toFixed(0)}%`;

            const avgPerTrade = total > 0 ? totalResult / total : 0;
            els.avgProfitLoss.textContent = `R$ ${avgPerTrade.toFixed(2)}`;
        }

        function updateBalances() {
            const today = new Date().toISOString().split('T')[0];
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekStartStr = weekStart.toISOString().split('T')[0];
            const [currentYear, currentMonth] = [currentDate.getFullYear(), String(currentDate.getMonth() + 1).padStart(2, '0')];

            let todayBal = 0, weekBal = 0, monthBal = 0, maxGain = -Infinity, maxLoss = Infinity;

            currentTrades.forEach(trade => {
                const amt = parseFloat(trade.amount);
                const tradeDate = trade.date;

                if (tradeDate === today) todayBal += amt;

                if (tradeDate >= weekStartStr) {
                    weekBal += amt;
                    if (amt > 0 && amt > maxGain) maxGain = amt; // Apenas gains
                    if (amt < 0 && amt < maxLoss) maxLoss = amt; // Apenas losses
                }

                if (tradeDate.startsWith(`${currentYear}-${currentMonth}`)) monthBal += amt;
            });

            els.todayBalance.textContent = `R$ ${todayBal.toFixed(2)}`;
            els.todayBalance.className = todayBal >= 0 ? 'text-2xl font-black text-green-600' : 'text-2xl font-black text-red-600';

            els.weekBalance.textContent = `R$ ${weekBal.toFixed(2)}`;
            els.weekBalance.className = weekBal >= 0 ? 'text-2xl font-black text-blue-600' : 'text-2xl font-black text-red-600';

            els.monthBalance.textContent = `R$ ${monthBal.toFixed(2)}`;
            els.monthBalance.className = monthBal >= 0 ? 'text-2xl font-black text-purple-600' : 'text-2xl font-black text-red-600';

            els.biggestGain.textContent = maxGain > 0 ? `R$ ${maxGain.toFixed(2)}` : 'R$ 0,00';
            els.biggestLoss.textContent = maxLoss < 0 ? `R$ ${Math.abs(maxLoss).toFixed(2)}` : 'R$ 0,00';
        }

        // Navegação do Calendário
        document.getElementById('prevMonth').onclick = () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        };
        document.getElementById('nextMonth').onclick = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        };

        // --- Lógica do Formulário (Salvar/Editar) ---
        els.tradeForm.onsubmit = async (e) => {
            e.preventDefault();
            const amount = parseFloat(els.tradeAmount.value);
            const contracts = parseInt(els.tradeContracts.value) || 1;
            const tradeTypeInput = document.querySelector('input[name="tradeType"]:checked');

            if (isNaN(amount) || !tradeTypeInput || !els.tradeAsset.value) {
                console.warn('Preencha todos os campos obrigatórios!'); // Substituímos o alert
                return;
            }

            const tradeData = {
                userId: userId,
                date: currentEditingDate,
                amount: amount,
                contracts: contracts,
                asset: els.tradeAsset.value,
                type: tradeTypeInput.value,
                notes: els.tradeNotes.value || '',
            };

            try {
                if (currentEditingTradeId) {
                    tradeData.updatedAt = new Date().toISOString();
                    await setDoc(doc(operationsCollection, currentEditingTradeId), tradeData, { merge: true });
                } else {
                    tradeData.createdAt = new Date().toISOString();
                    await addDoc(operationsCollection, tradeData);
                }
                resetForm();
                openModal(currentEditingDate);
            } catch (error) {
                console.error("Erro ao salvar:", error);
                console.warn('Erro ao salvar. Tente novamente.'); // Substituímos o alert
            }
        };

        els.deleteTrade.onclick = async () => {
            if (!currentEditingTradeId) return;
            try {
                await deleteDoc(doc(operationsCollection, currentEditingTradeId));
                resetForm();
                openModal(currentEditingDate);
            } catch (error) {
                console.error("Erro ao deletar:", error);
                console.warn('Erro ao deletar.'); // Substituímos o alert
            }
        };

        // --- Lógica do Gráfico de Patrimônio ---
        function updateEquityChart() {
            const initialEquity = parseFloat(els.initialEquity.value) || 0;
            const sortedTrades = [...currentTrades].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = ['Início'];
            const data = [initialEquity];
            let currentEquity = initialEquity;

            const dailyResults = {};
            sortedTrades.forEach(trade => {
                const date = trade.date;
                if (!dailyResults[date]) dailyResults[date] = 0;
                dailyResults[date] += parseFloat(trade.amount);
            });

            Object.keys(dailyResults).sort().forEach(date => {
                currentEquity += dailyResults[date];
                labels.push(date);
                data.push(currentEquity.toFixed(2));
            });

            const isDarkMode = document.documentElement.classList.contains('dark');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDarkMode ? '#f3f4f6' : '#111827';

            if (equityChartInstance) equityChartInstance.destroy();

            equityChartInstance = new Chart(els.equityChart, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Patrimônio',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: (ctx) => { // Gradiente de cor do seu layout
                            const chart = ctx.chart;
                            const gradient = chart.ctx.createLinearGradient(0, 0, 0, chart.height);
                            
                            // --- INÍCIO DA CORREÇÃO ---
                            // Garante que a altura do gráfico e o eixo Y são válidos
                            if (!chart.height || !isFinite(chart.height) || chart.height <= 0 || !chart.scales.y) {
                                // Retorna uma cor sólida se o gráfico não estiver pronto
                                return 'rgba(59, 130, 246, 0.1)';
                            }

                            const zeroY = chart.scales.y.getPixelForValue(initialEquity); // Baseado no início
                            
                            // Garante que 'zeroY' é um número finito
                            if (!isFinite(zeroY)) {
                                return 'rgba(59, 130, 246, 0.1)'; 
                            }

                            const ratio = Math.max(0, Math.min(1, zeroY / chart.height)); // Garante 0-1
                            // --- FIM DA CORREÇÃO ---
                            
                            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.1)'); // Azul claro (acima)
                            gradient.addColorStop(ratio, 'rgba(59, 130, 246, 0.1)');
                            gradient.addColorStop(ratio, 'rgba(239, 68, 68, 0.1)'); // Vermelho claro (abaixo)
                            gradient.addColorStop(1, 'rgba(239, 68, 68, 0.1)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // <-- AJUSTE AQUI
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: labelColor,
                                callback: function(value) { return 'R$ ' + value.toFixed(2); }
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: labelColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: labelColor } }
                    }
                }
            });
        }
        els.updateEquityChart.onclick = updateEquityChart;

        // --- Lógica de Análise (A VERSÃO DETALHADA) ---
        function updateAnalysis() {
            els.analysisByAsset.innerHTML = '';
            els.analysisByType.innerHTML = '';
            els.detailedAnalysis.innerHTML = ''; // Limpa a nova secção
            
            const analysis = {
                byAsset: {},
                byType: {}
            };
            
            // 1. Processa todos os trades
            currentTrades.forEach(trade => {
                const amount = parseFloat(trade.amount);
                const asset = trade.asset || 'N/A';
                const type = trade.type || 'N/A'; // 'Buy' or 'Sell'
                const contracts = parseInt(trade.contracts) || 1;

                // --- Inicializa estruturas ---
                if (!analysis.byAsset[asset]) {
                    analysis.byAsset[asset] = {
                        total: 0,
                        count: 0,
                        buy: { total: 0, wins: 0, losses: 0, count: 0, contracts: 0 },
                        sell: { total: 0, wins: 0, losses: 0, count: 0, contracts: 0 }
                    };
                }
                if (!analysis.byType[type]) {
                    analysis.byType[type] = { total: 0, wins: 0, losses: 0, count: 0, contracts: 0 };
                }

                // --- Agrega por Tipo (Geral) ---
                if(type !== 'N/A') {
                    analysis.byType[type].total += amount;
                    analysis.byType[type].count++;
                    analysis.byType[type].contracts += contracts;
                    if (amount > 0) analysis.byType[type].wins++;
                    if (amount < 0) analysis.byType[type].losses++;
                }

                // --- Agrega por Ativo (Geral) ---
                if(asset !== 'N/A') {
                    analysis.byAsset[asset].total += amount;
                    analysis.byAsset[asset].count++;
                }

                // --- Agrega por Ativo (Detalhado Buy/Sell) ---
                const detailType = (type === 'Buy') ? 'buy' : (type === 'Sell' ? 'sell' : null);
                
                if (asset !== 'N/A' && detailType) {
                    analysis.byAsset[asset][detailType].total += amount;
                    analysis.byAsset[asset][detailType].count++;
                    analysis.byAsset[asset][detailType].contracts += contracts;
                    if (amount > 0) analysis.byAsset[asset][detailType].wins++;
                    if (amount < 0) analysis.byAsset[asset][detailType].losses++;
                }
            });

            // --- 2. Renderização ---

            // Helper: Resumo Geral (para Ativo e Tipo)
            const renderSummaryRow = (label, data) => {
                const totalColor = data.total >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                const totalWins = (data.wins !== undefined) ? data.wins : data.buy.wins + data.sell.wins;
                const totalLosses = (data.losses !== undefined) ? data.losses : data.buy.losses + data.sell.losses;
                const totalCount = (data.count !== undefined) ? data.count : data.buy.count + data.sell.count;
                const totalContracts = (data.contracts !== undefined) ? data.contracts : data.buy.contracts + data.sell.contracts;
                const summaryWinRate = totalCount > 0 ? ((totalWins / totalCount) * 100).toFixed(0) : 0;

                return `
                    <div class="p-3 bg-gray-100 dark:bg-gray-700/60 rounded-lg flex justify-between items-center">
                        <span class="font-semibold text-base">${label}</span>
                        <div class="text-right">
                            <span class="font-bold text-lg ${totalColor}">R$ ${data.total.toFixed(2)}</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${totalWins} W / ${totalLosses} L (${summaryWinRate}%) | ${totalContracts} Contratos</p>
                        </div>
                    </div>
                `;
            };
            
            // Helper: Detalhe (Buy/Sell)
            const renderDetailRow = (label, data) => {
                if (data.count === 0) {
                    return `
                        <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700/30 rounded">
                            <span class="font-semibold">${label}</span>
                            <span class="text-xs text-gray-400">Nenhum trade</span>
                        </div>
                    `;
                }
                const totalColor = data.total >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                const winRate = (data.wins / data.count * 100).toFixed(0);
                return `
                    <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700/30 rounded">
                        <div>
                            <span class="font-semibold">${label}</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${data.wins} W / ${data.losses} L (${winRate}%) | ${data.contracts} Contratos</p>
                        </div>
                        <span class="font-bold ${totalColor}">R$ ${data.total.toFixed(2)}</span>
                    </div>
                `;
            };

            // Renderiza Resumo por Ativo
            if (Object.keys(analysis.byAsset).length === 0) {
                 els.analysisByAsset.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">Sem dados.</p>';
            } else {
                Object.entries(analysis.byAsset).sort((a,b) => b[1].total - a[1].total).forEach(([asset, data]) => {
                    els.analysisByAsset.innerHTML += renderSummaryRow(asset, data);
                });
            }

            // Renderiza Resumo por Tipo
            if (Object.keys(analysis.byType).length === 0) {
                 els.analysisByType.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">Sem dados.</p>';
            } else {
                Object.entries(analysis.byType).sort((a,b) => b[1].total - a[1].total).forEach(([type, data]) => {
                    els.analysisByType.innerHTML += renderSummaryRow(type, data);
                });
            }
            
            // Renderiza Análise Detalhada
            if (Object.keys(analysis.byAsset).length > 0) {
                Object.entries(analysis.byAsset).sort((a,b) => b[1].total - a[1].total).forEach(([asset, data]) => {
                    els.detailedAnalysis.innerHTML += `
                        <div class="p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm mb-4">
                            <h4 class="text-lg font-semibold mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">${asset}</h4>
                            <div class="space-y-2">
                                ${renderDetailRow('Buy', data.buy)}
                                ${renderDetailRow('Sell', data.sell)}
                            </div>
                        </div>
                    `;
                });
            } else {
                els.detailedAnalysis.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">Sem dados para análise detalhada.</p>';
            }
        }


        // --- Lógica de Abas ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'bg-white', 'dark:bg-gray-700', 'text-blue-600', 'dark:text-blue-300');
                    b.classList.add('text-gray-600', 'dark:text-gray-400');
                });
                btn.classList.add('active', 'bg-white', 'dark:bg-gray-700', 'text-blue-600', 'dark:text-blue-300');
                btn.classList.remove('text-gray-600', 'dark:text-gray-400');

                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(btn.dataset.tab).classList.remove('hidden');

                if (btn.dataset.tab === 'patrimonio') updateEquityChart();
                if (btn.dataset.tab === 'analise') updateAnalysis();
            });
        });

        // --- Lógica de Tema ---
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sun');
        const moonIcon = document.getElementById('moon');
        function setMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            }
            if (equityChartInstance) updateEquityChart();
        }
        themeToggle.addEventListener('click', () => setMode(!document.documentElement.classList.contains('dark')));
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) setMode(true);

        // --- Inicialização Firebase ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            getAnalytics(app); // Inicializa o Analytics

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const collectionPath = `artifacts/${appId}/public/data/operations`;
                    operationsCollection = collection(db, collectionPath);
                    
                    onSnapshot(query(operationsCollection), (snapshot) => {
                        currentTrades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderCalendar(); // Renderiza o calendário com os dados
                        
                        // Atualiza as abas ativas
                        if (!document.getElementById('patrimonio').classList.contains('hidden')) updateEquityChart();
                        if (!document.getElementById('analise').classList.contains('hidden')) updateAnalysis();
                    }, (error) => {
                         console.error("Erro ao buscar dados (onSnapshot):", error);
                    });

                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Erro no login anônimo:", error);
                    });
                }
            });
        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
        }

        // Render inicial (para mostrar o calendário vazio antes dos dados chegarem)
        renderCalendar();
    </script>
</body>
</html>

