<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Diário de Trades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Remove a barra de rolagem padrão do body quando o menu mobile está aberto */
        body.menu-open {
            overflow: hidden;
        }

        /* Estilos do Calendário */
        .day-box { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            font-size: 0.75rem; 
            border-radius: 1rem; /* Mais arredondado */
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        .dark .day-box {
            border-color: #374151; /* dark:border-gray-700 */
        }
        .day-box:not(.empty):hover {
            background: #f3f4f6; /* hover:bg-gray-100 */
        }
        .dark .day-box:not(.empty):hover {
            background: #374151; /* dark:hover:bg-gray-700 */
        }
        .day-box.empty {
            opacity: 0.3;
        }
        .value-box {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 80%; 
            height: 60%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 0.8rem; 
            border-radius: 0.5rem; 
            background: rgba(34,197,94,0.1); 
            color: #166534;
            border: 1px solid rgba(34,197,94,0.2);
        }
        /* CORREÇÃO: Verde e Vermelho mais fortes no Dark Mode */
        .dark .value-box {
             background: rgba(74, 222, 128, 0.15);
             color: #4ade80; /* green-400 */
             border-color: rgba(74, 222, 128, 0.3);
        }
        .value-box.loss { 
            background: rgba(239,68,68,0.1); 
            color: #991b1b; 
            border-color: rgba(239,68,68,0.2);
        }
         .dark .value-box.loss { 
            background: rgba(248, 113, 113, 0.15); 
            color: #f87171; /* red-400 */
            border-color: rgba(248, 113, 113, 0.3);
        }

        /* NOVO: Estilo para o resumo da semana */
        .week-summary-box {
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            border-radius: 1rem;
            background: #f3f4f6; /* bg-gray-100 */
            padding: 0.5rem;
            font-size: 0.7rem;
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .dark .week-summary-box {
            background: #1f2937; /* dark:bg-gray-800 */
            border-color: #374151; /* dark:border-gray-700 */
        }
        
        /* Estilo para botões de rádio Buy/Sell no modal */
        input[name="tradeType"]:checked + span {
            filter: brightness(1.2);
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        /* Estilos Gráfico Donut (Análise) */
        .donut-chart {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(#16a34a var(--wins, 0deg), #e11d48 var(--wins, 0deg) 360deg);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .donut-chart::before {
            content: '';
            position: absolute;
            width: 60px; 
            height: 60px;
            background: #f9fafb; /* bg-gray-50 */
            border-radius: 50%;
        }
        .dark .donut-chart::before {
             background: #1f2937; /* dark:bg-gray-800 */
        }
        .donut-chart-text {
            position: relative;
            z-index: 10;
            font-size: 1.25rem;
            font-weight: 800;
        }

        /* Estilo para botões de filtro ativos */
        .filter-btn.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff;
        }
        /* Estilo para botões da sidebar ativos */
        .sidebar-btn.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    
    <div class="flex min-h-screen">
        <!-- BOTÃO HAMBURGUER (Mobile) -->
        <button id="menuToggle" class="lg:hidden fixed top-4 left-4 z-50 p-3 bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-lg shadow-lg">
            <i class="fas fa-bars"></i>
        </button>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-64 bg-gray-900 dark:bg-gray-950 text-white p-6 flex flex-col fixed inset-y-0 left-0 z-40
                           transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl">
            
            <!-- Logo -->
            <div class="flex items-center gap-3 mb-10 pt-4 lg:pt-0">
                <i class="fas fa-chart-line text-4xl text-blue-400"></i>
                <h1 class="text-2xl font-black text-white">Diário de Trades</h1>
            </div>

            <!-- Card Conta (como na referência) -->
            <div class="bg-gray-800/50 dark:bg-gray-800 rounded-2xl p-4 mb-8 text-center space-y-2">
                <div>
                    <p class="text-sm text-gray-400">Desempenho Geral</p>
                    <p id="contaValor" class="text-3xl font-bold text-white">R$ 0,00</p>
                </div>
                <!-- NOVO: Saldo da Semana -->
                <div class="border-t border-gray-700 pt-2">
                    <p class="text-sm text-gray-400">Saldo da Semana (Atual)</p>
                    <p id="sidebarWeekBalance" class="text-xl font-bold text-white">R$ 0,00</p>
                </div>
            </div>

            <!-- Navegação -->
            <nav class="flex-grow space-y-3">
                <button data-tab="diario" class="sidebar-btn active w-full flex items-center gap-4 px-5 py-3 rounded-xl text-lg font-semibold transition-all hover:bg-gray-800">
                    <i class="fas fa-calendar-alt fa-fw"></i>
                    <span>Diário</span>
                </button>
                <button data-tab="patrimonio" class="sidebar-btn w-full flex items-center gap-4 px-5 py-3 rounded-xl text-lg font-semibold transition-all hover:bg-gray-800 text-gray-400">
                    <i class="fas fa-chart-line fa-fw"></i>
                    <span>Patrimônio</span>
                </button>
                <button data-tab="analise" class="sidebar-btn w-full flex items-center gap-4 px-5 py-3 rounded-xl text-lg font-semibold transition-all hover:bg-gray-800 text-gray-400">
                    <i class="fas fa-chart-pie fa-fw"></i>
                    <span>Análise</span>
                </button>
            </nav>

            <!-- Botão Tema -->
            <div class="mt-auto">
                <button id="themeToggle" class="w-full flex items-center justify-center gap-3 px-5 py-4 bg-yellow-500/10 dark:bg-indigo-500/10 text-yellow-500 dark:text-indigo-400 rounded-xl font-semibold transition-all hover:bg-yellow-500/20 dark:hover:bg-indigo-500/20">
                    <i class="fas fa-sun" id="sun"></i>
                    <i class="fas fa-moon hidden" id="moon"></i>
                    <span id="themeToggleText">Tema Claro</span>
                </button>
            </div>
        </aside>

        <!-- OVERLAY (Mobile) -->
        <div id="overlay" class="lg:hidden fixed inset-0 bg-black/50 z-30 hidden"></div>

        <!-- CONTEÚDO PRINCIPAL -->
        <main class="flex-1 lg:ml-64 p-4 md:p-8 lg:p-12 transition-all duration-300">
            <!-- Header do Conteúdo (substitui o header antigo) -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div>
                    <h2 id="pageTitle" class="text-3xl font-bold text-gray-800 dark:text-gray-100">Calendário de Trades</h2>
                    <p class="text-gray-500 dark:text-gray-200">Registre seus ganhos e perdas diárias.</p>
                </div>
                <!-- Resumo (como na referência) -->
                <div class="flex gap-6 bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-2xl shadow-lg p-4">
                    <div class="text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-200">Resultado do Mês</p>
                        <p id="headerNetResult" class="text-xl font-bold text-green-600">R$ 0,00</p>
                    </div>
                    <div class="border-l border-gray-200 dark:border-gray-700"></div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-200">Win Rate</p>
                        <p id="headerWinRate" class="text-xl font-bold text-blue-600">0%</p>
                    </div>
                </div>
            </div>

            <!-- Conteúdo das Abas -->
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-3xl shadow-2xl p-4 sm:p-6 lg:p-8">
                
                <!-- DIÁRIO -->
                <section id="diario" class="tab-content space-y-6">
                    <div class="flex justify-between items-center">
                        <button id="prevMonth" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="currentMonthYear" class="text-2xl font-bold text-gray-800 dark:text-gray-100"></h2>
                        <button id="nextMonth" class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>

                    <!-- CALENDÁRIO -->
                    <div>
                        <!-- MUDANÇA: Grid com 8 colunas -->
                        <div class="grid grid-cols-8 text-center font-bold text-sm uppercase tracking-wider text-gray-500 dark:text-gray-300 py-4">
                            <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                            <div class="text-blue-600 dark:text-blue-400">Semana</div>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-8 gap-2">
                            <!-- Dias e Resumos da Semana serão inseridos aqui -->
                        </div>
                    </div>
                </section>

                <!-- PATRIMÔNIO -->
                <section id="patrimonio" class="tab-content hidden space-y-8">
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <!-- Input de Saldo Inicial -->
                        <div class="flex gap-2 items-center">
                            <label class="text-sm font-medium dark:text-gray-200">Inicial (R$):</label>
                            <input type="number" id="initialEquity" value="0" class="px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50 w-32">
                        </div>
                        
                        <!-- NOVO: Filtros de Período do Gráfico -->
                        <nav id="equityChartFilters" class="flex bg-gray-100 dark:bg-gray-700/60 rounded-xl shadow-lg overflow-hidden p-1">
                            <button data-filter="all" class="filter-btn active px-5 py-2 font-semibold text-gray-600 dark:text-gray-100 rounded-lg transition-all">Geral</button>
                            <button data-filter="month" class="filter-btn px-5 py-2 font-semibold text-gray-600 dark:text-gray-100 rounded-lg transition-all">Mês</button>
                            <button data-filter="week" class="filter-btn px-5 py-2 font-semibold text-gray-600 dark:text-gray-100 rounded-lg transition-all">Semana</button>
                            <button data-filter="day" class="filter-btn px-5 py-2 font-semibold text-gray-600 dark:text-gray-100 rounded-lg transition-all">Dia</button>
                        </nav>
                    </div>
                    
                    <div class="relative h-64 md:h-96">
                        <canvas id="equityChart"></canvas>
                    </div>

                    <!-- CARDS DE RESUMO (Patrimônio) -->
                    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-gray-50 dark:bg-gray-700/60 rounded-2xl shadow-lg text-center">
                            <p class="text-sm opacity-70 mb-2 dark:text-gray-300">Lucro Hoje</p>
                            <p id="patrimonioToday" class="text-2xl font-black text-gray-700 dark:text-gray-100">R$ 0,00</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700/60 rounded-2xl shadow-lg text-center">
                            <p class="text-sm opacity-70 mb-2 dark:text-gray-300">Lucro Semana</p>
                            <p id="patrimonioWeek" class="text-2xl font-black text-gray-700 dark:text-gray-100">R$ 0,00</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700/60 rounded-2xl shadow-lg text-center">
                            <p class="text-sm opacity-70 mb-2 dark:text-gray-300">Lucro Mês</p>
                            <p id="patrimonioMonth" class="text-2xl font-black text-gray-700 dark:text-gray-100">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg text-white text-center">
                            <p class="text-sm opacity-90 mb-2">Maior Lucro (Geral)</p>
                            <p id="patrimonioBiggestGain" class="text-2xl font-black">R$ 0,00</p>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-rose-500 to-red-600 rounded-2xl shadow-lg text-white text-center">
                            <p class="text-sm opacity-90 mb-2">Maior Perca (Geral)</p>
                            <p id="patrimonioBiggestLoss" class="text-2xl font-black">R$ 0,00</p>
                        </div>
                    </div>
                </section>

                <!-- ANÁLISE -->
                <section id="analise" class="tab-content hidden space-y-8">
                    <!-- FILTROS DE ANÁLISE -->
                    <div class="flex justify-center">
                        <nav id="analysisChartFilters" class="flex bg-gray-100 dark:bg-gray-700/60 rounded-xl shadow-lg overflow-hidden p-1">
                            <button data-filter="all" class="filter-btn active px-5 py-2 font-semibold text-gray-600 dark:text-gray-100 rounded-lg transition-all">Geral</button>
                            <button data-filter="month" class="filter-btn px-5 py-2 font-semibold text-gray-600 dark:text-gray-100 rounded-lg transition-all">Mês</button>
                            <button data-filter="week" class="filter-btn px-5 py-2 font-semibold text-gray-600 dark:text-gray-100 rounded-lg transition-all">Semana</button>
                            <button data-filter="day" class="filter-btn px-5 py-2 font-semibold text-gray-600 dark:text-gray-100 rounded-lg transition-all">Dia</button>
                        </nav>
                    </div>

                    <!-- Títulos fora dos grids e grids para os novos cards -->
                    <h3 class="text-xl font-bold flex items-center gap-2 pt-4 border-t border-gray-200 dark:border-gray-700/50 dark:text-gray-100"><i class="fas fa-coins text-yellow-500"></i> Desempenho por Ativo</h3>
                    <div id="analysisByAsset" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Cards de Ativo serão inseridos aqui pelo JS -->
                    </div>

                    <h3 class="text-xl font-bold flex items-center gap-2 mt-8 pt-4 border-t border-gray-200 dark:border-gray-700/50 dark:text-gray-100"><i class="fas fa-arrows-alt-h text-purple-500"></i> Desempenho por Tipo (Buy/Sell)</h3>
                    <div id="analysisByType" class="grid md:grid-cols-2 gap-6">
                        <!-- Cards de Tipo serão inseridos aqui pelo JS -->
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700/60 rounded-2xl p-5 mt-8 shadow-inner">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2 dark:text-gray-100"><i class="fas fa-search-dollar text-cyan-500"></i> Detalhado por Ativo</h3>
                        <div id="detailedAnalysis" class="space-y-4">
                            <!-- Análise detalhada (como estava) -->
                        </div>
                    </div>
                </section>

            </div> <!-- Fim do bg-white (main card) -->
        </main>
    </div>

    <!-- MODAL (Sem alterações, exceto o fundo para dark mode) -->
    <div id="tradeModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl w-full max-w-lg p-8 relative transform scale-95 transition-all duration-300" id="modalContent">
            <button id="closeModal" class="absolute top-4 right-6 text-3xl text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">&times;</button>
            <h3 class="text-2xl font-bold mb-6 dark:text-gray-100">Operações do Dia</h3>
            <div id="dailyTradesList" class="max-h-40 overflow-y-auto mb-6 border border-gray-200 dark:border-gray-700 rounded-lg py-2"></div>
            <h4 id="formTitle" class="text-xl font-bold mb-4 dark:text-gray-100">Adicionar Operação</h4>
            <form id="tradeForm" class="space-y-4">
                <input type="hidden" id="tradeDate">
                <div>
                    <label class="block font-semibold mb-2 dark:text-gray-200">Valor (R$)</label>
                    <input type="number" step="0.01" id="tradeAmount" required placeholder="150.00 ou -50.00" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50 dark:text-gray-100">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2 dark:text-gray-200">Ativo</label>
                        <select id="tradeAsset" required class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50 dark:text-gray-100">
                            <option value="">Selecione...</option>
                            <option value="XAUUSD">XAUUSD</option>
                            <option value="S&P500">S&P500</option>
                            <option value="Nasdaq">Nasdaq</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2 dark:text-gray-200">Contratos</label>
                        <input type="number" id="tradeContracts" min="1" value="1" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50 dark:text-gray-100">
                    </div>
                </div>
                <div>
                    <label class="block font-semibold mb-2 dark:text-gray-200">Tipo</label>
                    <div class="flex gap-4">
                        <label class="cursor-pointer"><input type="radio" name="tradeType" value="Buy" checked class="sr-only"><span class="px-6 py-3 rounded-xl bg-green-500 text-white font-bold shadow-md hover:shadow-lg transition-all duration-200">Buy</span></label>
                        <label class="cursor-pointer"><input type="radio" name="tradeType" value="Sell" class="sr-only"><span class="px-6 py-3 rounded-xl bg-red-500 text-white font-bold shadow-md hover:shadow-lg transition-all duration-200">Sell</span></label>
                    </div>
                </div>
                <div>
                    <label class="block font-semibold mb-2 dark:text-gray-200">Notas (opcional)</label>
                    <textarea id="tradeNotes" rows="2" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-4 focus:ring-blue-500/50 dark:text-gray-100" placeholder="Ex: Rompimento de topo..."></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="deleteTrade" class="hidden px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-md transition">Excluir</button>
                    <button type="submit" id="saveTradeBtn" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase imports e config (exato do seu código original)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged }
            from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query }
            from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics }
            from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDYXehc5ijr11GD029ph7-6a0oVy9ddcKY",
            authDomain: "meu-diario-de-trades.firebaseapp.com",
            projectId: "meu-diario-de-trades",
            storageBucket: "meu-diario-de-trades.firebasestorage.app",
            messagingSenderId: "744192474673",
            appId: "1:744192474673:web:c5adf1d9526b81deed1f10",
            measurementId: "G-LM9V31W7BE"
        };
        const appId = 'meu-diario-de-trades';

        // Variáveis Globais
        let app, db, auth, userId, operationsCollection;
        let currentTrades = [];
        let equityChartInstance = null;
        let currentEditingTradeId = null;
        let currentDate = new Date();
        let currentAnalysisFilter = 'all'; 
        let currentEquityFilter = 'all'; // NOVO: Filtro para o gráfico de patrimônio
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        // Elementos DOM 
        const els = {
            // Sidebar e Header
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('overlay'),
            pageTitle: document.getElementById('pageTitle'),
            headerNetResult: document.getElementById('headerNetResult'),
            headerWinRate: document.getElementById('headerWinRate'),
            contaValor: document.getElementById('contaValor'),
            sidebarWeekBalance: document.getElementById('sidebarWeekBalance'), // NOVO

            // Calendário
            currentMonthYear: document.getElementById('currentMonthYear'),
            calendarGrid: document.getElementById('calendarGrid'),
            
            // Modal
            tradeModal: document.getElementById('tradeModal'),
            modalContent: document.getElementById('modalContent'), 
            closeModal: document.getElementById('closeModal'),
            tradeForm: document.getElementById('tradeForm'),
            tradeAmount: document.getElementById('tradeAmount'),
            tradeContracts: document.getElementById('tradeContracts'),
            tradeAsset: document.getElementById('tradeAsset'),
            tradeNotes: document.getElementById('tradeNotes'),
            deleteTrade: document.getElementById('deleteTrade'),
            saveTradeBtn: document.getElementById('saveTradeBtn'),
            dailyTradesList: document.getElementById('dailyTradesList'),
            formTitle: document.getElementById('formTitle'),
            
            // Objetos Falsos (para manter a lógica sem erros)
            netResult: document.getElementById('headerNetResult'), 
            winRate: document.getElementById('headerWinRate'),
            totalTrades: { textContent: '' }, 
            avgProfitLoss: { textContent: '' }, 
            todayBalance: { textContent: '', className: '' }, 
            weekBalance: { textContent: '', className: '' }, 
            monthBalance: { textContent: '', className: '' }, 
            biggestGain: { textContent: '' }, 
            biggestLoss: { textContent: '' }, 

            // Patrimônio
            initialEquity: document.getElementById('initialEquity'),
            equityChart: document.getElementById('equityChart').getContext('2d'),
            patrimonioToday: document.getElementById('patrimonioToday'),
            patrimonioWeek: document.getElementById('patrimonioWeek'),
            patrimonioMonth: document.getElementById('patrimonioMonth'),
            patrimonioBiggestGain: document.getElementById('patrimonioBiggestGain'),
            patrimonioBiggestLoss: document.getElementById('patrimonioBiggestLoss'),

            // Análise
            analysisByAsset: document.getElementById('analysisByAsset'),
            analysisByType: document.getElementById('analysisByType'),
            detailedAnalysis: document.getElementById('detailedAnalysis')
        };

        let currentEditingDate = null;
        const pageTitles = {
            diario: "Calendário de Trades",
            patrimonio: "Evolução do Patrimônio",
            analise: "Análise de Desempenho"
        };
        const pageSubtitles = {
            diario: "Registre seus ganhos e perdas diárias.",
            patrimonio: "Veja a curva de evolução da sua conta.",
            analise: "Filtre seus resultados por período."
        };

        // --- Funções do Menu (Sidebar) ---
        function openMenu() {
            els.sidebar.classList.remove('-translate-x-full');
            els.overlay.classList.remove('hidden');
            document.body.classList.add('menu-open');
        }
        function closeMenu() {
            els.sidebar.classList.add('-translate-x-full');
            els.overlay.classList.add('hidden');
            document.body.classList.remove('menu-open');
        }
        document.getElementById('menuToggle').onclick = openMenu;
        els.overlay.onclick = closeMenu; // Corrigido

        // --- Funções do Modal ---
        function openModal(date) {
            if (!date) return;
            currentEditingDate = date;
            resetForm();
            els.dailyTradesList.innerHTML = '';
            const tradesOfTheDay = currentTrades.filter(t => t.date === date).sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
            if (tradesOfTheDay.length > 0) {
                tradesOfTheDay.forEach(trade => {
                    const amount = parseFloat(trade.amount);
                    const typeLabel = trade.type === 'Buy' ? 'B' : 'S';
                    const assetLabel = trade.asset || 'N/A';
                    const contracts = trade.contracts || 1;
                    const amountColor = amount >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                    els.dailyTradesList.innerHTML += `
                        <div class="p-3 mx-2 flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg transition" data-trade-id="${trade.id}">
                            <div>
                                <span class="font-bold ${amountColor}">R$ ${amount.toFixed(2)}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(${contracts}c, ${assetLabel}/${typeLabel})</span>
                            </div>
                            <i class="fas fa-pencil-alt text-xs text-gray-400"></i>
                        </div>
                    `;
                });
                els.dailyTradesList.querySelectorAll('[data-trade-id]').forEach(item => {
                    item.addEventListener('click', () => loadTradeForEdit(item.dataset.tradeId));
                });
            } else {
                els.dailyTradesList.innerHTML = '<p class="p-4 text-sm text-gray-400 dark:text-gray-500 text-center">Nenhuma operação neste dia.</p>';
            }
            els.tradeModal.classList.remove('hidden');
            setTimeout(() => els.modalContent.classList.add('scale-100'), 10);
            els.tradeAmount.focus();
        }

        function resetForm() {
            els.tradeForm.reset();
            els.tradeContracts.value = '1';
            els.tradeAsset.value = '';
            els.tradeNotes.value = '';
            document.querySelector('input[name="tradeType"][value="Buy"]').checked = true;
            currentEditingTradeId = null;
            els.deleteTrade.classList.add('hidden');
            els.saveTradeBtn.textContent = 'Salvar';
            els.formTitle.textContent = 'Adicionar Nova Operação';
        }

        function loadTradeForEdit(tradeId) {
            const trade = currentTrades.find(t => t.id === tradeId);
            if (!trade) return;
            els.tradeAmount.value = trade.amount;
            els.tradeContracts.value = trade.contracts || 1;
            els.tradeAsset.value = trade.asset || '';
            els.tradeNotes.value = trade.notes || '';
            document.querySelector(`input[name="tradeType"][value="${trade.type || 'Buy'}"]`).checked = true;
            currentEditingTradeId = tradeId;
            els.saveTradeBtn.textContent = 'Atualizar';
            els.formTitle.textContent = 'Editar Operação';
            els.deleteTrade.classList.remove('hidden');
            els.tradeAmount.focus();
        }

        function closeModal() {
            els.modalContent.classList.remove('scale-100');
            setTimeout(() => {
                els.tradeModal.classList.add('hidden');
                currentEditingDate = null;
                resetForm();
            }, 300); 
        }
        els.closeModal.onclick = closeModal;
        els.tradeModal.addEventListener('click', (e) => { 
            if (e.target === els.tradeModal) closeModal(); 
        });

        // --- Funções do Calendário e Resumos ---
        function renderCalendar() {
            els.calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            els.currentMonthYear.textContent = `${monthNames[month]} ${year}`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const monthTrades = currentTrades.filter(t => {
                const [tYear, tMonth] = t.date.split('-').map(Number);
                return tYear === year && (tMonth - 1) === month;
            });

            const tradesByDay = {};
            monthTrades.forEach(trade => {
                const day = parseInt(trade.date.split('-')[2]);
                if (!tradesByDay[day]) tradesByDay[day] = [];
                tradesByDay[day].push(parseFloat(trade.amount));
            });

            // MUDANÇA: Lógica para Saldo da Semana
            let weekTrades = [];
            let dayCounter = 0;

            // Dias em branco (Respeitando a grade de 8 colunas)
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'day-box empty bg-gray-50 dark:bg-gray-800/50';
                els.calendarGrid.appendChild(emptyDay);
                dayCounter++;
            }

            // Dias do mês
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayTrades = tradesByDay[day] || [];
                let dayResult = dayTrades.reduce((acc, val) => acc + val, 0);

                // Acumula trades da semana
                weekTrades.push(...dayTrades);

                const dayEl = document.createElement('div');
                dayEl.className = 'day-box bg-white dark:bg-gray-800 p-1 cursor-pointer transition-all';
                dayEl.dataset.date = dateString;
                dayEl.innerHTML = `
                    <span class="absolute top-2 left-2 text-xs font-bold text-gray-500 dark:text-gray-300">${day}</span>
                    ${dayTrades.length > 0 ? `<div class="value-box ${dayResult >= 0 ? '' : 'loss'}">R$ ${Math.abs(dayResult).toFixed(2)}</div>` : ''}
                `;
                dayEl.addEventListener('click', () => openModal(dateString));
                if (dayTrades.length > 0) dayEl.classList.add('has-trade');
                els.calendarGrid.appendChild(dayEl);
                dayCounter++;

                // Se for Sábado (dia 6 do week index, que agora é 0-indexed para 7 colunas)
                // ou o último dia do mês
                const isSaturday = (firstDay + day - 1) % 7 === 6;
                const isLastDay = day === daysInMonth;

                // Adiciona o resumo da semana
                if (isSaturday || isLastDay) {
                    const weekResult = weekTrades.reduce((acc, val) => acc + val, 0);
                    const summaryBox = document.createElement('div');
                    summaryBox.className = 'week-summary-box';
                    
                    const resultColor = weekResult >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                    summaryBox.innerHTML = `
                        <span class="text-xs font-bold text-gray-500 dark:text-gray-300">Total</span>
                        <span class="font-black text-lg ${resultColor}">R$ ${weekResult.toFixed(2)}</span>
                    `;
                    els.calendarGrid.appendChild(summaryBox);
                    
                    // Reseta para a próxima semana
                    weekTrades = [];
                }

                // Se for o último dia E não for sábado, preenche o resto da linha
                if (isLastDay && !isSaturday) {
                     // Quantos dias faltam para o sábado (coluna 6)
                    const remainingDays = 6 - ((firstDay + day - 1) % 7);
                    for (let i = 0; i < remainingDays; i++) {
                        const emptyDay = document.createElement('div');
                        emptyDay.className = 'day-box empty bg-gray-50 dark:bg-gray-800/50';
                        els.calendarGrid.appendChild(emptyDay);
                    }
                }
            }

            updateHeaderSummary(monthTrades);
            updatePatrimonioSummary();
        }


        // Atualiza o resumo no header e na sidebar
        function updateHeaderSummary(monthTrades) {
            const totalResult = monthTrades.reduce((acc, t) => acc + parseFloat(t.amount), 0);
            const winningTrades = monthTrades.filter(t => parseFloat(t.amount) > 0).length;
            const total = monthTrades.length;

            els.headerNetResult.textContent = `R$ ${totalResult.toFixed(2)}`;
            els.headerNetResult.className = totalResult >= 0 ? 'text-xl font-bold text-green-600' : 'text-xl font-bold text-red-600';

            const winRate = total > 0 ? (winningTrades / total) * 100 : 0;
            els.headerWinRate.textContent = `${winRate.toFixed(0)}%`;
            
            // Atualiza o card da conta na sidebar com o lucro total GERAL
            const totalGeral = currentTrades.reduce((acc, t) => acc + parseFloat(t.amount), 0);
            els.contaValor.textContent = `R$ ${totalGeral.toFixed(2)}`;
            els.contaValor.className = totalGeral >= 0 ? 'text-3xl font-bold text-green-400' : 'text-3xl font-bold text-red-400';

            // ATUALIZA SALDO DA SEMANA (NOVO)
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay()); 
            const weekStartStr = weekStart.toISOString().split('T')[0];
            let weekBal = 0;
            currentTrades.forEach(trade => {
                if (trade.date >= weekStartStr) {
                    weekBal += parseFloat(trade.amount);
                }
            });
            els.sidebarWeekBalance.textContent = `R$ ${weekBal.toFixed(2)}`;
            els.sidebarWeekBalance.className = weekBal >= 0 ? 'text-xl font-bold text-green-400' : 'text-xl font-bold text-red-400';
        }

        // Navegação do Calendário
        document.getElementById('prevMonth').onclick = () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        };
        document.getElementById('nextMonth').onclick = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        };

        // --- Lógica do Formulário (Salvar/Editar) ---
        els.tradeForm.onsubmit = async (e) => {
            e.preventDefault();
            const amount = parseFloat(els.tradeAmount.value);
            const contracts = parseInt(els.tradeContracts.value) || 1;
            const tradeTypeInput = document.querySelector('input[name="tradeType"]:checked');

            if (isNaN(amount) || !tradeTypeInput || !els.tradeAsset.value) {
                console.warn('Preencha todos os campos obrigatórios!'); 
                return;
            }

            const tradeData = {
                userId: userId,
                date: currentEditingDate,
                amount: amount,
                contracts: contracts,
                asset: els.tradeAsset.value,
                type: tradeTypeInput.value,
                notes: els.tradeNotes.value || '',
            };

            try {
                if (currentEditingTradeId) {
                    tradeData.updatedAt = new Date().toISOString();
                    await setDoc(doc(operationsCollection, currentEditingTradeId), tradeData, { merge: true });
                } else {
                    tradeData.createdAt = new Date().toISOString();
                    await addDoc(operationsCollection, tradeData);
                }
                resetForm();
                openModal(currentEditingDate);
            } catch (error) {
                console.error("Erro ao salvar:", error);
                console.warn('Erro ao salvar. Tente novamente.'); 
            }
        };

        els.deleteTrade.onclick = async () => {
            if (!currentEditingTradeId) return;
            try {
                await deleteDoc(doc(operationsCollection, currentEditingTradeId));
                resetForm();
                openModal(currentEditingDate);
            } catch (error) {
                console.error("Erro ao deletar:", error);
                console.warn('Erro ao deletar.'); 
            }
        };

        // --- Lógica do Gráfico de Patrimônio (COM FILTROS) ---
        function updateEquityChart() {
            const initialEquity = parseFloat(els.initialEquity.value) || 0;
            
            // --- NOVO: Lógica de Filtragem de Trades ---
            const today = new Date().toISOString().split('T')[0];
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekStartStr = weekStart.toISOString().split('T')[0];
            const monthStart = new Date();
            monthStart.setDate(1);
            const monthStartStr = monthStart.toISOString().split('T')[0];

            const filteredTrades = currentTrades.filter(trade => {
                if (currentEquityFilter === 'all') return true;
                if (currentEquityFilter === 'day') return trade.date === today;
                if (currentEquityFilter === 'week') return trade.date >= weekStartStr;
                if (currentEquityFilter === 'month') return trade.date >= monthStartStr;
                return true;
            });
            // --- Fim da Lógica de Filtragem ---

            const sortedTrades = [...filteredTrades].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = ['Início'];
            const data = [initialEquity];
            let currentEquity = initialEquity;

            const dailyResults = {};
            sortedTrades.forEach(trade => {
                const date = trade.date;
                if (!dailyResults[date]) dailyResults[date] = 0;
                dailyResults[date] += parseFloat(trade.amount);
            });

            Object.keys(dailyResults).sort().forEach(date => {
                currentEquity += dailyResults[date];
                labels.push(date);
                data.push(currentEquity.toFixed(2));
            });

            const isDarkMode = document.documentElement.classList.contains('dark');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDarkMode ? '#f3f4f6' : '#111827';

            if (equityChartInstance) equityChartInstance.destroy();

            equityChartInstance = new Chart(els.equityChart, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Patrimônio',
                        data: data,
                        borderColor: (ctx) => {
                            const chart = ctx.chart;
                            const {ctx: canvasCtx, chartArea} = chart;
                            if (!chartArea) {
                                return '#16a34a'; // Verde padrão
                            }
                            const gradient = canvasCtx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            // O "eixo 0" é o valor inicial
                            const zeroY = chart.scales.y.getPixelForValue(initialEquity); 
                            
                            if (!isFinite(zeroY)) {
                                return '#16a34a'; // Verde padrão
                            }

                            const ratio = Math.max(0, Math.min(1, zeroY / chartArea.bottom));
                            
                            gradient.addColorStop(0, '#ef4444'); // Vermelho
                            gradient.addColorStop(ratio, '#ef4444');
                            gradient.addColorStop(ratio, '#22c55e'); // Verde
                            gradient.addColorStop(1, '#22c55e');
                            return gradient;
                        },
                        backgroundColor: (ctx) => {
                            const chart = ctx.chart;
                            const {ctx: canvasCtx, chartArea} = chart;
                            if (!chartArea) {
                                return 'rgba(34, 197, 94, 0.2)'; // Verde padrão
                            }
                            const gradient = canvasCtx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            const zeroY = chart.scales.y.getPixelForValue(initialEquity); // Eixo 0 é o inicial
                            
                            if (!isFinite(zeroY) || chartArea.bottom <= 0) {
                                return 'rgba(34, 197, 94, 0.2)'; // Verde padrão
                            }

                            const ratio = Math.max(0, Math.min(1, zeroY / chartArea.bottom));

                            // CORREÇÃO: Cores mais fortes (verde e vermelho)
                            gradient.addColorStop(0, 'rgba(239, 68, 68, 0.3)'); // Vermelho mais forte
                            gradient.addColorStop(ratio, 'rgba(239, 68, 68, 0.3)');
                            gradient.addColorStop(ratio, 'rgba(34, 197, 94, 0.3)'); // Verde mais forte
                            gradient.addColorStop(1, 'rgba(34, 197, 94, 0.3)'); 
                            return gradient;
                        },
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: labelColor,
                                callback: function(value) { return 'R$ ' + value.toFixed(2); }
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: labelColor },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: labelColor } }
                    }
                }
            });
        }
        // Atualiza o gráfico quando o saldo inicial muda
        els.initialEquity.addEventListener('change', updateEquityChart); 
        
        // --- NOVO: Lógica para Filtros do Gráfico de Patrimônio ---
        document.querySelectorAll('#equityChartFilters .filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentEquityFilter = btn.dataset.filter;
                document.querySelectorAll('#equityChartFilters .filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                updateEquityChart();
            });
        });


        // --- Função para os CARDS DO PATRIMÔNIO ---
        function updatePatrimonioSummary() {
            const today = new Date().toISOString().split('T')[0];
            
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay()); 
            const weekStartStr = weekStart.toISOString().split('T')[0];
            
            const monthStart = new Date();
            monthStart.setDate(1); 
            const monthStartStr = monthStart.toISOString().split('T')[0];

            let todayBal = 0, weekBal = 0, monthBal = 0;
            let maxGain = 0, maxLoss = 0; 

            currentTrades.forEach(trade => {
                const amt = parseFloat(trade.amount);
                const tradeDate = trade.date;

                if (tradeDate === today) todayBal += amt;
                if (tradeDate >= weekStartStr) weekBal += amt;
                if (tradeDate >= monthStartStr) monthBal += amt;

                if (amt > maxGain) maxGain = amt;
                if (amt < maxLoss) maxLoss = amt;
            });

            // Atualiza Hoje
            els.patrimonioToday.textContent = `R$ ${todayBal.toFixed(2)}`;
            els.patrimonioToday.className = todayBal >= 0 ? 'text-2xl font-black text-green-600 dark:text-green-400' : 'text-2xl font-black text-red-600 dark:text-red-400';

            // Atualiza Semana
            els.patrimonioWeek.textContent = `R$ ${weekBal.toFixed(2)}`;
            els.patrimonioWeek.className = weekBal >= 0 ? 'text-2xl font-black text-green-600 dark:text-green-400' : 'text-2xl font-black text-red-600 dark:text-red-400';

            // Atualiza Mês
            els.patrimonioMonth.textContent = `R$ ${monthBal.toFixed(2)}`;
            els.patrimonioMonth.className = monthBal >= 0 ? 'text-2xl font-black text-green-600 dark:text-green-400' : 'text-2xl font-black text-red-600 dark:text-red-400';
            
            els.patrimonioBiggestGain.textContent = `R$ ${maxGain.toFixed(2)}`;
            els.patrimonioBiggestLoss.textContent = `R$ ${Math.abs(maxLoss).toFixed(2)}`;
        }


        // --- Lógica de Análise ---
        function updateAnalysis() {
            const today = new Date().toISOString().split('T')[0];
            
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekStartStr = weekStart.toISOString().split('T')[0];
            
            const monthStart = new Date();
            monthStart.setDate(1);
            const monthStartStr = monthStart.toISOString().split('T')[0];

            const filteredTrades = currentTrades.filter(trade => {
                if (currentAnalysisFilter === 'all') return true;
                if (currentAnalysisFilter === 'day') return trade.date === today;
                if (currentAnalysisFilter === 'week') return trade.date >= weekStartStr;
                if (currentAnalysisFilter === 'month') return trade.date >= monthStartStr;
                return true;
            });

            els.analysisByAsset.innerHTML = '';
            els.analysisByType.innerHTML = '';
            els.detailedAnalysis.innerHTML = ''; 
            
            const analysis = {
                byAsset: {},
                byType: {}
            };
            
            filteredTrades.forEach(trade => {
                const amount = parseFloat(trade.amount);
                const asset = trade.asset || 'N/A';
                const type = trade.type || 'N/A';
                const contracts = parseInt(trade.contracts) || 1;

                if (!analysis.byAsset[asset]) {
                    analysis.byAsset[asset] = {
                        total: 0,
                        count: 0,
                        buy: { total: 0, wins: 0, losses: 0, count: 0, contracts: 0 },
                        sell: { total: 0, wins: 0, losses: 0, count: 0, contracts: 0 }
                    };
                }
                if (!analysis.byType[type]) {
                    analysis.byType[type] = { total: 0, wins: 0, losses: 0, count: 0, contracts: 0 };
                }

                if(type !== 'N/A') {
                    analysis.byType[type].total += amount;
                    analysis.byType[type].count++;
                    analysis.byType[type].contracts += contracts;
                    if (amount > 0) analysis.byType[type].wins++;
                    if (amount < 0) analysis.byType[type].losses++;
                }

                if(asset !== 'N/A') {
                    analysis.byAsset[asset].total += amount;
                    analysis.byAsset[asset].count++;
                }

                const detailType = (type === 'Buy') ? 'buy' : (type === 'Sell' ? 'sell' : null);
                
                if (asset !== 'N/A' && detailType) {
                    analysis.byAsset[asset][detailType].total += amount;
                    analysis.byAsset[asset][detailType].count++;
                    analysis.byAsset[asset][detailType].contracts += contracts;
                    if (amount > 0) analysis.byAsset[asset][detailType].wins++;
                    if (amount < 0) analysis.byAsset[asset][detailType].losses++;
                }
            });

            // --- 2. Renderização ---

            const renderAnalysisCard = (label, data) => {
                const totalColor = data.total >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                
                const totalWins = (data.wins !== undefined) ? data.wins : data.buy.wins + data.sell.wins;
                const totalLosses = (data.losses !== undefined) ? data.losses : data.buy.losses + data.sell.losses;
                const totalCount = totalWins + totalLosses;
                const totalContracts = (data.contracts !== undefined) ? data.contracts : data.buy.contracts + data.sell.contracts;
                
                const winRate = totalCount > 0 ? ((totalWins / totalCount) * 100) : 0;
                const winDegrees = (winRate / 100) * 360;

                return `
                    <div class="p-4 bg-gray-50 dark:bg-gray-700/60 rounded-2xl shadow-lg flex items-center gap-4">
                        <div class="flex-shrink-0">
                            <div class="donut-chart" style="--wins: ${winDegrees.toFixed(0)}deg">
                                <div class="donut-chart-text ${winRate >= 50 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                    ${winRate.toFixed(0)}<span class="text-xs">%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-grow">
                            <h4 class="font-semibold text-lg dark:text-gray-100">${label}</h4>
                            <div class="flex justify-between items-center mt-1">
                                <span class="font-bold text-xl ${totalColor}">R$ ${data.total.toFixed(2)}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-300">${totalContracts} Contratos</span>
                            </div>
                            <div class="mt-2 space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-200">
                                        <i class="fas fa-arrow-up text-green-500 mr-1"></i> Winners:
                                    </span>
                                    <span class="font-semibold dark:text-gray-100">${totalWins}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-200">
                                        <i class="fas fa-arrow-down text-red-500 mr-1"></i> Losers:
                                    </span>
                                    <span class="font-semibold dark:text-gray-100">${totalLosses}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            const renderDetailRow = (label, data) => {
                if (data.count === 0) {
                    return `
                        <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700/50 rounded">
                            <span class="font-semibold dark:text-gray-100">${label}</span>
                            <span class="text-xs text-gray-400 dark:text-gray-400">Nenhum trade</span>
                        </div>
                    `;
                }
                const totalColor = data.total >= 0 ? 'text-green-500 dark:text-green-400' : 'text-red-500 dark:text-red-400';
                const winRate = (data.wins / data.count * 100).toFixed(0);
                return `
                    <div class="flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700/50 rounded">
                        <div>
                            <span class="font-semibold dark:text-gray-100">${label}</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${data.wins} W / ${data.losses} L (${winRate}%) | ${data.contracts} Contratos</p>
                        </div>
                        <span class="font-bold ${totalColor}">R$ ${data.total.toFixed(2)}</span>
                    </div>
                `;
            };

            if (Object.keys(analysis.byAsset).length === 0 && filteredTrades.length === 0) {
                 els.analysisByAsset.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center col-span-full">Nenhum dado para este período.</p>`;
            } else {
                Object.entries(analysis.byAsset).sort((a,b) => b[1].total - a[1].total).forEach(([asset, data]) => {
                    els.analysisByAsset.innerHTML += renderAnalysisCard(asset, data);
                });
            }

            if (Object.keys(analysis.byType).length === 0 && filteredTrades.length === 0) {
                 els.analysisByType.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center col-span-full">Nenhum dado para este período.</p>`;
            } else {
                Object.entries(analysis.byType).sort((a,b) => b[1].total - a[1].total).forEach(([type, data]) => {
                    els.analysisByType.innerHTML += renderAnalysisCard(type, data);
                });
            }
            
            if (filteredTrades.length > 0 && Object.keys(analysis.byAsset).length > 0) {
                Object.entries(analysis.byAsset).sort((a,b) => b[1].total - a[1].total).forEach(([asset, data]) => {
                    els.detailedAnalysis.innerHTML += `
                        <div class="p-4 bg-gray-100 dark:bg-gray-700/50 rounded-lg shadow-sm mb-4">
                            <h4 class="text-lg font-semibold mb-3 border-b border-gray-200 dark:border-gray-700 pb-2 dark:text-gray-100">${asset}</h4>
                            <div class="space-y-2">
                                ${renderDetailRow('Buy', data.buy)}
                                ${renderDetailRow('Sell', data.sell)}
                            </div>
                        </div>
                    `;
                });
            } else {
                els.detailedAnalysis.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center">Nenhum dado para este período.</p>`;
            }
        }


        // --- Lógica de Abas (Sidebar) ---
        document.querySelectorAll('.sidebar-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                // Atualiza botões
                document.querySelectorAll('.sidebar-btn').forEach(b => {
                    b.classList.remove('active', 'text-white');
                    b.classList.add('text-gray-400', 'hover:bg-gray-800');
                });
                btn.classList.add('active', 'text-white');
                btn.classList.remove('text-gray-400', 'hover:bg-gray-800');

                // Atualiza conteúdo
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(tab).classList.remove('hidden');

                // Atualiza título da página
                els.pageTitle.textContent = pageTitles[tab] || "Dashboard";
                els.pageTitle.nextElementSibling.textContent = pageSubtitles[tab] || "";

                // Funções específicas da aba
                if (tab === 'patrimonio') {
                    // Reseta e atualiza o gráfico de patrimônio
                    currentEquityFilter = 'all';
                    document.querySelectorAll('#equityChartFilters .filter-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('#equityChartFilters .filter-btn[data-filter="all"]').classList.add('active');
                    updateEquityChart();
                    updatePatrimonioSummary(); // Atualiza os cards
                }
                if (tab === 'analise') {
                    // Reseta e atualiza a análise
                    currentAnalysisFilter = 'all';
                    document.querySelectorAll('#analysisChartFilters .filter-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('#analysisChartFilters .filter-btn[data-filter="all"]').classList.add('active');
                    updateAnalysis();
                }

                // Fecha menu mobile ao clicar
                if (window.innerWidth < 1024) {
                    closeMenu();
                }
            });
        });

        // --- Lógica: Filtro de Análise ---
        document.querySelectorAll('#analysisChartFilters .filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentAnalysisFilter = btn.dataset.filter;
                document.querySelectorAll('#analysisChartFilters .filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                updateAnalysis();
            });
        });


        // --- Lógica de Tema ---
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sun');
        const moonIcon = document.getElementById('moon');
        const themeToggleText = document.getElementById('themeToggleText');

        function setMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                themeToggleText.textContent = "Tema Escuro";
                themeToggle.classList.remove('bg-yellow-500/10', 'text-yellow-500', 'hover:bg-yellow-500/20');
                themeToggle.classList.add('bg-indigo-500/10', 'text-indigo-400', 'hover:bg-indigo-500/20');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                themeToggleText.textContent = "Tema Claro";
                themeToggle.classList.add('bg-yellow-500/10', 'text-yellow-500', 'hover:bg-yellow-500/20');
                themeToggle.classList.remove('bg-indigo-500/10', 'text-indigo-400', 'hover:bg-indigo-500/20');
                localStorage.setItem('theme', 'light');
            }
            if (equityChartInstance) updateEquityChart();
        }
        themeToggle.addEventListener('click', () => setMode(!document.documentElement.classList.contains('dark')));
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            setMode(true);
        } else {
            setMode(false);
        }

        // --- Inicialização Firebase ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            getAnalytics(app); 

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const collectionPath = `artifacts/${appId}/public/data/operations`;
                    operationsCollection = collection(db, collectionPath);
                    
                    onSnapshot(query(operationsCollection), (snapshot) => {
                        currentTrades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderCalendar(); 
                        updatePatrimonioSummary();

                        // Atualiza as abas ativas
                        if (!document.getElementById('patrimonio').classList.contains('hidden')) updateEquityChart();
                        if (!document.getElementById('analise').classList.contains('hidden')) updateAnalysis();
                    }, (error) => {
                         console.error("Erro ao buscar dados (onSnapshot):", error);
                    });

                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Erro no login anônimo:", error);
                    });
                }
            });
        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
        }

        // Render inicial e ativação de filtros
        renderCalendar();
        document.querySelector('.sidebar-btn[data-tab="diario"]').click(); // Clica na primeira aba

    </script>
</body>
</html>
